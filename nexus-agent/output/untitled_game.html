<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Photosynthesis Collector</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
        canvas { display: block; }
    </style>
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
</head>
<body>
<script>
/**
 * @file Photosynthesis Collector
 * @author Your Name
 * @version 1.0
 * 
 * @description A reaction game teaching the inputs and outputs of photosynthesis.
 * 
 * ## Lesson Objectives to Game Mechanics Mapping:
 * - **Objective:** Students will identify the inputs (sunlight, water, carbon dioxide) 
 *   and outputs (oxygen, glucose) of photosynthesis.
 * - **Mechanic:** The core gameplay loop requires players to categorize falling text 
 *   labels as either "inputs" to catch or "outputs" to avoid. Correct categorization 
 *   (catching inputs, avoiding outputs) increases the score, while incorrect actions
 *   (catching outputs, missing inputs) decrease it, directly testing and reinforcing
 *   the learning objective in a timed, engaging format.
 */

// Initialize Kaplay
kaplay({
    width: 800,
    height: 600,
    background: [100, 149, 237], // Cornflower Blue for the sky
    stretch: true,
    letterbox: true,
});

// --- Constants ---
const PLAYER_SPEED = 400;
const GAME_DURATION = 60; // seconds
const SPAWN_RATE = 0.8; // seconds

const ELEMENTS = [
    { name: "Sunlight", type: "input", color: rgb(255, 255, 0) },
    { name: "Water", type: "input", color: rgb(0, 191, 255) },
    { name: "CO2", type: "input", color: rgb(169, 169, 169) },
    { name: "Oxygen", type: "output", color: rgb(240, 248, 255) },
    { name: "Glucose", type: "output", color: rgb(255, 105, 180) },
];

// --- Helper Functions ---
function addButton(txt, p, action) {
    const btn = add([
        rect(240, 60, { radius: 8 }),
        pos(p),
        anchor("center"),
        area(),
        outline(4),
        color(34, 139, 34),
        "button",
    ]);
    add([
        text(txt, { size: 32 }),
        pos(p),
        anchor("center"),
        color(255, 255, 255),
    ]);
    onClick("button", () => action());
    return btn;
}

// --- Scene Definitions ---

// Menu Scene: Title, instructions, and start button
scene("menu", () => {
    add([
        text("Photosynthesis Collector", { size: 48, width: width() - 40 }),
        pos(center().x, height() * 0.2),
        anchor("center"),
    ]);

    add([
        text("Use LEFT/RIGHT arrows to move.", { size: 24 }),
        pos(center().x, height() * 0.4),
        anchor("center"),
    ]);

    add([
        text("Catch INPUTS: Sunlight, Water, CO2\nAvoid OUTPUTS: Oxygen, Glucose", {
            size: 24,
            align: "center",
            width: width() - 40,
        }),
        pos(center().x, height() * 0.55),
        anchor("center"),
    ]);

    addButton("Start Game", vec2(center().x, height() * 0.8), () => go("game"));
});

// Game Scene: The main gameplay
scene("game", () => {
    let score = 0;
    let timer = GAME_DURATION;

    // Add a simple ground
    add([
        rect(width(), 40),
        pos(0, height() - 40),
        color(139, 69, 19), // Brown
    ]);

    // Add player (the plant's collection zone)
    const player = add([
        rect(120, 20),
        pos(center().x, height() - 60),
        anchor("center"),
        color(0, 128, 0), // Green
        area(),
        "player",
    ]);

    // Player Movement
    onKeyDown("left", () => player.move(-PLAYER_SPEED, 0));
    onKeyDown("right", () => player.move(PLAYER_SPEED, 0));

    // Keep player within screen bounds
    player.onUpdate(() => {
        if (player.pos.x < 0) player.pos.x = 0;
        if (player.pos.x > width()) player.pos.x = width();
    });

    // UI Elements
    const scoreText = add([
        text(`Score: ${score}`, { size: 32 }),
        pos(20, 20),
        { value: score },
    ]);

    const timerText = add([
        text(`Time: ${timer}`, { size: 32 }),
        pos(width() - 20, 20),
        anchor("topright"),
        { value: timer },
    ]);

    // Update score function
    function updateScore(points) {
        score += points;
        scoreText.text = `Score: ${score}`;
        // Add a little visual feedback on score change
        scoreText.scale = 1.2;
        tween(scoreText.scale, 1, 0.2, (s) => scoreText.scale = s, easings.easeOutElastic);
    }

    // Spawn falling elements
    loop(SPAWN_RATE, () => {
        const elementData = choose(ELEMENTS);
        add([
            text(elementData.name, { size: 28 }),
            pos(rand(20, width() - 20), -20),
            anchor("center"),
            move(DOWN, 120 + rand(-20, 20)),
            area(),
            color(elementData.color),
            elementData.type, // "input" or "output" tag
            "element",
        ]);
    });

    // Collision with player
    onCollide("player", "input", (p, inputEl) => {
        updateScore(10);
        destroy(inputEl);
        // play("hit", { volume: 0.2, detune: 600 }); // Commented out as per asset constraints (No Audio)
    });

    onCollide("player", "output", (p, outputEl) => {
        updateScore(-10);
        destroy(outputEl);
        // play("hit", { volume: 0.2, detune: -600 }); // Commented out as per asset constraints (No Audio)
    });

    // Handle elements falling off-screen
    onUpdate("element", (el) => {
        if (el.pos.y > height() + 20) {
            // Penalize for missing an input
            if (el.is("input")) {
                updateScore(-5);
            }
            destroy(el);
        }
    });

    // Countdown timer
    loop(1, () => {
        timer--;
        timerText.text = `Time: ${timer}`;
        if (timer <= 0) {
            go("results", { score: score });
        }
    });
});

// Results Scene: Show final score and play again button
scene("results", ({ score }) => {
    add([
        text("Time's Up!", { size: 48 }),
        pos(center().x, height() * 0.2),
        anchor("center"),
    ]);

    add([
        text(`Final Score: ${score}`, { size: 64 }),
        pos(center().x, height() * 0.4),
        anchor("center"),
    ]);

    add([
        text("Inputs (like CO2) build plants.\nOutputs (like Oxygen) are released.", {
            size: 24,
            width: width() - 80,
            align: "center",
        }),
        pos(center().x, height() * 0.6),
        anchor("center"),
    ]);

    addButton("Play Again", vec2(center().x, height() * 0.85), () => go("menu"));
});

// Start the game
go("menu");

</script>
</body>
</html>