<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fractal Grid - Geometric Series</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #05050f;
            overflow: hidden;
            font-family: monospace;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <!-- 
        LESSON OBJECTIVES:
        1. Geometric Series: Understand the structure of geometric sequences (a, ar, ar^2...).
        2. Sum Formula: Apply S_n = a(1-r^n)/(1-r) to solve for the sum of finite geometric series.
        3. Common Ratio: Identify the multiplier 'r' between terms.
    -->
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
    <script>
        // ============================================================
        //  THE FRACTAL GRID
        //  A Cyber-Math Platformer about Geometric Series
        // ============================================================

        // ----- 1. GAME CONFIG -----
        const CONFIG = {
            gravity: 1600,
            jumpForce: 600,
            moveSpeed: 300,
            maxFallSpeed: 900,
            
            // Level Data & State
            playerStartPos: { x: 50, y: 0 },
            playerHealth: 3,
            
            cameraFollow: true,

            // Theme Colors (Neon/Cyberpunk)
            bgColor: [5, 5, 15],           // Deep Space
            floorColor: [10, 10, 30],      // Dark Grid
            floorHighlight: [0, 100, 200], // Neon Edge
            platformColor: [0, 100, 255],  // Electric Blue
            hazardColor: [255, 0, 80],     // Error Red
            coinColor: [255, 200, 0],      // Gold Ratio
            portalColor: [180, 80, 255],   // Dimensional Purple
            gateColor: [255, 0, 255],      // Locked Magenta
            playerColor: [0, 255, 255],    // Vector Cyan
        };

        // Geometric Series Data for Sum Gates
        const SERIES_DATA = [
            { 
                id: 0, 
                text: "2 + 6 + 18 + 54", 
                n: 4, 
                correct: 80, // a=2, r=3, n=4 -> S_4 = 2(1-3^4)/(1-3) = 80
                wrong: [72, 84] 
            },
            { 
                id: 1, 
                text: "5 + 10 + 20 + ... (n=5)", 
                n: 5, 
                correct: 155, // a=5, r=2, n=5 -> S_5 = 5(1-2^5)/(1-2) = 155
                wrong: [150, 160] 
            }
        ];

        // ----- 2. LEVEL MAPS -----
        // 'G' marks the Sum Gate location
        const LEVELS = [
            // --- Level 1 ---
            [
                "                                        ",
                "                                        ",
                "                                        ",
                "                         $   $          ",
                "                        ------          ",
                "            $  $                        ",
                "           ------           $  $        ",
                "                           ------    G  ",
                "    $  $                           ====  ",
                "   ------                              >",
                "                   $                    ",
                "  @              =====     ===          ",
                "========   ^^^  ========  ======  ======",
            ],
            // --- Level 2 ---
            [
                "                                        ",
                "                                   G    ",
                "                                  ===   ",
                "                       $  $            >",
                "                      ------            ",
                "           $                   $        ",
                "          ---              ------       ",
                "                                        ",
                "    $         $     $                   ",
                "   ---    ------  -----                 ",
                "                                        ",
                "  @                          ===        ",
                "=====  ^^^  ====  ^^^  ====  ^^^^^^  ===",
            ]
        ];

        // ----- 3. INITIALIZE KAPLAY -----
        kaplay({
            background: CONFIG.bgColor,
            width: 800,
            height: 480,
            scale: 1,
            global: true, 
            letterbox: true,
            debug: false,
            buttons: {
                jump: { keyboard: ["space", "w", "up"], gamepad: ["south"] },
                left: { keyboard: ["a", "left"], gamepad: ["dpad-left"] },
                right: { keyboard: ["d", "right"], gamepad: ["dpad-right"] },
            },
        });

        const TILE = 32;

        // ----- 4. HELPER: Particle Effects -----
        function spawnExplosion(p) {
            for (let i = 0; i < 12; i++) {
                add([
                    rect(6, 6),
                    pos(p),
                    color(255, 230, 100),
                    anchor("center"),
                    move(rand(0, 360), rand(100, 400)),
                    lifespan(0.6, { fade: 0.6 }),
                    opacity(1),
                    z(200)
                ]);
            }
        }

        // ----- 5. HELPER: Build Level -----
        function buildLevel(mapData, levelIdx) {
            let spawnPos = vec2(CONFIG.playerStartPos.x, CONFIG.playerStartPos.y);

            for (let row = 0; row < mapData.length; row++) {
                for (let col = 0; col < mapData[row].length; col++) {
                    const ch = mapData[row][col];
                    const x = col * TILE;
                    const y = row * TILE;

                    switch (ch) {
                        // Ground Block
                        case "=":
                            const ground = add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.floorColor),
                                "ground",
                            ]);
                            // Add neon top highlight
                            ground.add([
                                rect(TILE, 2),
                                pos(0, 0),
                                color(...CONFIG.floorHighlight),
                            ]);
                            break;

                        // One-way Platform (Energy Bar)
                        case "-":
                            add([
                                rect(TILE, 8),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.platformColor),
                                opacity(0.8),
                                "platform",
                            ]);
                            break;

                        // Player Spawn
                        case "@":
                            spawnPos = vec2(x, y);
                            break;

                        // Ratio Orb (Coin)
                        case "$":
                            const coinX = x + TILE / 2;
                            const coinY = y + TILE / 2;
                            add([
                                circle(8),
                                pos(coinX, coinY),
                                area(),
                                anchor("center"),
                                color(...CONFIG.coinColor),
                                z(5),
                                "coin",
                            ]);
                            // Label
                            add([
                                text("r", { size: 10, font: "monospace" }),
                                pos(coinX, coinY),
                                anchor("center"),
                                color(0, 0, 0),
                                z(6)
                            ]);
                            break;

                        // Calculation Error (Hazard) - Diamond Spikes
                        case "^":
                            add([
                                rect(16, 16),
                                pos(x + TILE/2, y + TILE - 8), 
                                rotate(45), // Sets initial rotation
                                anchor("center"),
                                area({ scale: 0.7 }), 
                                color(...CONFIG.hazardColor),
                                outline(2, rgb(100, 0, 0)),
                                "hazard",
                            ]);
                            break;

                        // Exit Portal
                        case ">":
                            add([
                                rect(TILE, TILE * 2),
                                pos(x, y - TILE),
                                area(),
                                anchor("topleft"),
                                color(...CONFIG.portalColor),
                                opacity(0.7),
                                z(1),
                                "portal",
                            ]);
                            break;
                        
                        // Sum Gate (Addon Feature)
                        case "G":
                            // Visual Gate Barrier
                            add([
                                rect(20, TILE * 3),
                                pos(x, y - TILE * 2),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.gateColor),
                                outline(2, rgb(255, 255, 255)),
                                "gateBarrier"
                            ]);
                            
                            // Invisible Trigger Zone (Left of gate)
                            add([
                                rect(60, TILE * 3),
                                pos(x - 150, y - TILE * 2),
                                area(),
                                opacity(0),
                                "gateTrigger",
                                { triggered: false, levelIdx: levelIdx }
                            ]);

                            // Formula Display
                            add([
                                text("SUM GATE\nLOCKED", { size: 12, font: "monospace", align: "center" }),
                                pos(x + 10, y - TILE * 3),
                                anchor("bottom"),
                                color(255, 255, 255),
                                "gateLabel"
                            ]);
                            break;
                    }
                }
            }

            return { spawnPos };
        }

        // ----- 6. MAIN GAME SCENE -----
        scene("game", (levelIdx = 0) => {
            setGravity(CONFIG.gravity);

            const { spawnPos } = buildLevel(LEVELS[levelIdx], levelIdx);
            
            let score = 0;
            let hp = CONFIG.playerHealth;
            let gateSolved = false;

            // --- Player Object (Vector Arrow Shape) ---
            const player = add([
                polygon([vec2(0, -15), vec2(12, 10), vec2(0, 5), vec2(-12, 10)]),
                pos(spawnPos),
                area({ scale: 0.8 }), 
                body(),
                // CRITICAL FIX: rotate(0) creates the 'angle' property needed for lerp()
                rotate(0), 
                anchor("center"),
                scale(1),
                color(...CONFIG.playerColor),
                outline(2, rgb(255, 255, 255)),
                z(10),
                "player",
            ]);

            // --- HUD ---
            const hpLabel = add([
                text(`HP: ${hp}`, { size: 18, font: "monospace" }),
                pos(16, 12),
                fixed(),
                z(100),
                color(255, 255, 255),
            ]);

            const scoreLabel = add([
                text(`Ratio Pts: ${score}`, { size: 18, font: "monospace" }),
                pos(16, 36),
                fixed(),
                z(100),
                color(...CONFIG.coinColor),
            ]);

            add([
                text(`Level ${levelIdx + 1}`, { size: 18, font: "monospace" }),
                pos(width() - 16, 12),
                anchor("topright"),
                fixed(),
                z(100),
                color(200, 200, 255),
            ]);
            
            // Controls Text
            add([
                text("ARROWS/WASD to Move", { size: 12, font: "monospace" }),
                pos(16, height() - 20),
                anchor("bottomleft"),
                fixed(),
                z(100),
                color(150, 150, 200)
            ]);

            // --- Movement ---
            onButtonDown("left", () => {
                player.move(-CONFIG.moveSpeed, 0);
                // Rotate player visual to point left slightly
                // This now works because player has the rotate() component
                player.angle = lerp(player.angle, -15, 0.2);
            });

            onButtonDown("right", () => {
                player.move(CONFIG.moveSpeed, 0);
                player.angle = lerp(player.angle, 15, 0.2);
            });

            // Reset angle when idle
            player.onUpdate(() => {
                if (!isKeyDown("left") && !isKeyDown("right")) {
                    player.angle = lerp(player.angle, 0, 0.2);
                }
            });

            onButtonPress("jump", () => {
                if (player.isGrounded()) {
                    player.jump(CONFIG.jumpForce);
                }
            });

            // --- Camera ---
            if (CONFIG.cameraFollow) {
                player.onUpdate(() => {
                    const curr = camPos();
                    // Smooth follow, lock Y slightly
                    const targetX = player.pos.x + 100;
                    const targetY = player.pos.y - 50;
                    
                    camPos(vec2(
                        lerp(curr.x, targetX, 0.05),
                        lerp(curr.y, targetY, 0.05)
                    ));
                });
            }

            // --- Core Mechanics ---
            player.onCollide("coin", (coin) => {
                destroy(coin);
                score++;
                scoreLabel.text = `Ratio Pts: ${score}`;
                spawnExplosion(coin.pos); 
            });

            player.onCollide("hazard", () => {
                takeDamage();
            });

            function takeDamage() {
                hp--;
                hpLabel.text = `HP: ${hp}`;
                shake(10);
                spawnExplosion(player.pos);
                
                if (hp <= 0) {
                    go("gameover", { score, level: levelIdx });
                } else {
                    player.pos = spawnPos.clone();
                    player.vel = vec2(0, 0);
                    // Flash red screen overlay
                    add([
                        rect(width(), height()),
                        color(255, 0, 0),
                        opacity(0.3),
                        fixed(),
                        lifespan(0.1, { fade: 0.1 }),
                        z(200)
                    ]);
                }
            }

            player.onCollide("portal", () => {
                // Portal only works if gate is gone
                if(get("gateBarrier").length > 0) {
                     return;
                }

                const nextLevel = levelIdx + 1;
                if (nextLevel < LEVELS.length) {
                    go("game", nextLevel);
                } else {
                    go("win", { score });
                }
            });

            // --- ADDON: Sum Formula Gate ---
            player.onCollide("gateTrigger", (trigger) => {
                if (trigger.triggered || gateSolved) return;
                
                trigger.triggered = true;
                const data = SERIES_DATA[levelIdx];
                
                // Display Question
                add([
                    text(`SOLVE:\n${data.text}\nFind Sum (Sn)`, { 
                        size: 20, 
                        font: "monospace", 
                        align: "center" 
                    }),
                    pos(player.pos.x, player.pos.y - 220),
                    anchor("center"),
                    color(255, 255, 0),
                    lifespan(15, { fade: 1 }),
                    opacity(1), // Required for lifespan fade
                    z(150),
                    "gateText"
                ]);

                // Prepare Orb Values
                let values = [data.correct, ...data.wrong];
                values = values.sort(() => Math.random() - 0.5); // Shuffle

                // Spawn Orbs
                values.forEach((val, i) => {
                    const angle = (i / values.length) * Math.PI * 2 - Math.PI/2; 
                    // Spacing them out in an arc above the gate area
                    const offsetX = (i - 1) * 100;
                    const orbPos = vec2(player.pos.x + offsetX, player.pos.y - 150);

                    const orb = add([
                        circle(28),
                        pos(orbPos),
                        color(0, 100, 200),
                        outline(2, rgb(255, 255, 255)),
                        area(),
                        anchor("center"),
                        z(160),
                        "sumOrb",
                        { value: val }
                    ]);
                    
                    // CRITICAL FIX: Add text as CHILD object so it gets destroyed with the orb
                    orb.add([
                        text(val, { size: 16, font: "monospace" }),
                        pos(0, 0), // Relative to parent center
                        anchor("center"),
                        color(255, 255, 255),
                        z(161)
                    ]);

                    // Float animation
                    orb.onUpdate(() => {
                        orb.pos.y += Math.sin(time() * 4 + i) * 0.5;
                    });
                });
            });

            // Orb Interaction
            player.onCollide("sumOrb", (orb) => {
                const data = SERIES_DATA[levelIdx];
                
                if (orb.value === data.correct) {
                    // CORRECT: Unlock Gate
                    // destroyAll("sumOrb") kills all orbs AND their child texts
                    destroyAll("sumOrb"); 
                    destroyAll("gateBarrier");
                    destroyAll("gateText");
                    destroyAll("gateLabel");
                    gateSolved = true;
                    spawnExplosion(orb.pos);
                    shake(5);
                    
                    // Success Text
                    add([
                        text("GATE OPEN!", { size: 24, font: "monospace" }),
                        pos(player.pos.x, player.pos.y - 100),
                        anchor("center"),
                        color(0, 255, 0),
                        lifespan(2, { fade: 1 }),
                        opacity(1),
                        z(100)
                    ]);
                } else {
                    // WRONG: Punishment
                    destroy(orb); // Destroys this specific orb AND its child text
                    
                    shake(10);
                    spawnExplosion(orb.pos);
                    spawnGlitches(player.pos);
                    
                    add([
                        text("ERROR!", { size: 24, font: "monospace" }),
                        pos(player.pos.x, player.pos.y - 100),
                        anchor("center"),
                        color(255, 0, 0),
                        lifespan(1, { fade: 0.5 }),
                        opacity(1),
                        z(100)
                    ]);
                }
            });

            function spawnGlitches(centerPos) {
                // Spawn 3 glitch enemies that fall
                for(let i=0; i<3; i++) {
                    add([
                        rect(20, 20),
                        pos(centerPos.x + rand(-100, 100), centerPos.y - 200),
                        area(),
                        body(),
                        color(220, 60, 80),
                        outline(2, rgb(255, 255, 255)),
                        lifespan(4, { fade: 1 }), 
                        opacity(1), // Required for lifespan
                        "hazard", // Reuses hazard collision logic
                        "glitch"
                    ]);
                }
            }

            // --- Fall off screen ---
            player.onUpdate(() => {
                if (player.pos.y > LEVELS[levelIdx].length * TILE + 300) {
                    takeDamage();
                }
            });

            // --- Parallax Background ---
            for(let i=0; i<20; i++) {
                 add([
                    rect(rand(20, 100), rand(20, 100)),
                    pos(rand(-500, 3000), rand(-200, 800)),
                    color(30, 30, 60),
                    opacity(0.3),
                    z(-10),
                    move(LEFT, rand(5, 15)) // Slow drift
                ]);
            }

        });

        // ----- 7. GAME OVER & WIN SCENES -----
        scene("gameover", ({ score, level }) => {
            add([
                text("SYSTEM FAILURE", { size: 48, font: "monospace" }),
                pos(center()),
                anchor("center"),
                color(255, 0, 80),
            ]);
            add([
                text(`Ratio Points: ${score}`, { size: 24, font: "monospace" }),
                pos(center().x, center().y + 60),
                anchor("center"),
                color(255, 255, 255),
            ]);
            add([
                text("Press SPACE to Reboot", { size: 18, font: "monospace" }),
                pos(center().x, center().y + 120),
                anchor("center"),
                color(100, 100, 200),
            ]);
            onKeyPress("space", () => go("game", level));
            onClick(() => go("game", level));
        });

        scene("win", ({ score }) => {
            add([
                text("SEQUENCE COMPLETE", { size: 48, font: "monospace" }),
                pos(center()),
                anchor("center"),
                color(0, 255, 255),
            ]);
            add([
                text(`Total Ratio Points: ${score}`, { size: 24, font: "monospace" }),
                pos(center().x, center().y + 60),
                anchor("center"),
                color(255, 200, 0),
            ]);
            add([
                text("Press SPACE to Re-Initialize", { size: 18, font: "monospace" }),
                pos(center().x, center().y + 120),
                anchor("center"),
                color(100, 100, 200),
            ]);
            onKeyPress("space", () => go("game", 0));
            onClick(() => go("game", 0));
        });

        // ----- 8. START GAME -----
        go("game", 0);

    </script>
</body>

</html>