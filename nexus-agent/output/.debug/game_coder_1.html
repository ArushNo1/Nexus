<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Photosynthesis Defender</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            background: #222;
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <!-- KAPLAY.js CDN -->
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
    <script>
        /**
         * PHOTOSYNTHESIS DEFENDER
         * 
         * EDUCATIONAL MAPPING:
         * 1. INPUTS: Player collects Sunlight (Yellow), Water (Blue), and CO2 (Gray).
         * 2. OUTPUTS: Collecting all three triggers "Glucose Blast" (Sugar) and releases Oxygen (Particles).
         * 3. PROCESS: Visualizes the transformation of raw materials into energy within a plant.
         */

        // -- CONFIG --
        const C = {
            playerSpeed: 300,
            bulletSpeed: 650,
            fireRate: 0.12,
            playerHP: 5,
            spawnRate: 1.1,
            enemySpeed: [90, 220],
            enemyHP: [1, 4],
            enemyFireRate: 1.5,
            bgStart: [60, 40, 20],   // Soil Dark Brown
            bgEnd: [135, 206, 235], // Sky Blue
            // Colors
            playerCol: [40, 200, 40],     // Leaf Green
            bulletCol: [255, 255, 200],   // Energy Pulse (Light Yellow)
            enemyBulletCol: [80, 50, 20], // Toxin (Brown)
            inputColors: {
                sunlight: [255, 220, 0],
                water: [0, 100, 255],
                co2: [150, 150, 150]
            }
        };

        // Initialize Kaplay
        kaplay({
            width: 480,
            height: 700,
            background: C.bgStart,
            crisp: true,
            letterbox: true,
        });

        // -- ASSETS & UTILS --

        // Background Layer: Soil to Sky transition
        function makeBackground() {
            const bg = add([
                rect(width(), height()),
                pos(0, 0),
                color(...C.bgStart),
                fixed(),
                z(-100),
                "bg-layer"
            ]);
            return bg;
        }

        // Particle System: Pollen/Air Bubbles (replaces Stars)
        function makePollen() {
            for (let i = 0; i < 40; i++) {
                add([
                    circle(rand(1, 3)),
                    pos(rand(0, width()), rand(0, height())),
                    color(255, 255, 200),
                    opacity(rand(0.2, 0.5)),
                    z(-10),
                    move(DOWN, rand(10, 40)),
                    offscreen({ destroy: false }),
                    "pollen",
                ]);
            }
            onUpdate("pollen", (p) => {
                if (p.pos.y > height() + 10) {
                    p.pos.y = -10;
                    p.pos.x = rand(0, width());
                }
            });
        }

        // ==================
        //  GAME SCENE
        // ==================
        scene("game", () => {
            const bgRect = makeBackground();
            makePollen();

            let score = 0;
            let fireTimer = 0;
            let gameOver = false;
            let spawnTimer = 0;
            let inputSpawnTimer = 0;
            let difficulty = 1;

            // Synthesis State
            const synthesis = {
                sunlight: false,
                water: false,
                co2: false
            };

            // -- PLAYER: Super-Leaf --
            const player = add([
                rect(40, 40, { radius: 10 }),
                pos(width() / 2, height() - 80),
                area(),
                anchor("center"),
                color(...C.playerCol),
                outline(2, rgb(20, 100, 20)),
                z(10),
                { hp: C.playerHP, invuln: 0 },
                "player",
            ]);

            // Leaf Vein detail
            player.add([
                rect(4, 30),
                anchor("center"),
                color(20, 100, 20),
                opacity(0.5)
            ]);
            
            // Label
            player.add([
                text("LEAF", { size: 10 }),
                pos(0, 25),
                anchor("center"),
                color(255, 255, 255),
                opacity(0.8)
            ]);

            // -- HUD --
            // Score
            const scoreTxt = add([
                text("Sugar: 0", { size: 20 }),
                pos(width() / 2, 14), anchor("top"), color(255, 255, 200), fixed(), z(50),
            ]);

            // Health (Leaf Icons)
            const hpTxt = add([
                text("ðŸŒ¿ ðŸŒ¿ ðŸŒ¿ ðŸŒ¿ ðŸŒ¿", { size: 16 }),
                pos(16, 14), color(80, 255, 80), fixed(), z(50),
            ]);

            // Synthesis Gauge UI
            const gaugeContainer = add([
                pos(width() - 110, 10), fixed(), z(50)
            ]);
            
            // Labels
            gaugeContainer.add([ text("Inputs:", { size: 12 }), pos(0, 0) ]);

            // Icons (Gray when empty, Colored when full)
            const gaugeSun = gaugeContainer.add([ circle(8), pos(10, 25), color(50, 50, 50), outline(1, WHITE) ]);
            const gaugeWater = gaugeContainer.add([ circle(8), pos(35, 25), color(50, 50, 50), outline(1, WHITE) ]);
            const gaugeCO2 = gaugeContainer.add([ circle(8), pos(60, 25), color(50, 50, 50), outline(1, WHITE) ]);
            
            // Helper text under icons
            gaugeContainer.add([ text("S", { size: 10 }), pos(10, 40), anchor("center") ]);
            gaugeContainer.add([ text("W", { size: 10 }), pos(35, 40), anchor("center") ]);
            gaugeContainer.add([ text("C", { size: 10 }), pos(60, 40), anchor("center") ]);

            function updateHUD() {
                scoreTxt.text = `Sugar: ${score}`;
                // HP
                let hearts = "";
                for (let i = 0; i < player.hp; i++) hearts += "ðŸŒ¿ ";
                hpTxt.text = hearts.trim();

                // Gauge Colors
                gaugeSun.color = synthesis.sunlight ? rgb(...C.inputColors.sunlight) : rgb(80, 80, 80);
                gaugeWater.color = synthesis.water ? rgb(...C.inputColors.water) : rgb(80, 80, 80);
                gaugeCO2.color = synthesis.co2 ? rgb(...C.inputColors.co2) : rgb(80, 80, 80);
            }

            // -- CONTROLS --
            onKeyDown("left", () => { if (!gameOver) player.move(-C.playerSpeed, 0); });
            onKeyDown("right", () => { if (!gameOver) player.move(C.playerSpeed, 0); });
            onKeyDown("up", () => { if (!gameOver) player.move(0, -C.playerSpeed); });
            onKeyDown("down", () => { if (!gameOver) player.move(0, C.playerSpeed); });
            onKeyDown("a", () => { if (!gameOver) player.move(-C.playerSpeed, 0); });
            onKeyDown("d", () => { if (!gameOver) player.move(C.playerSpeed, 0); });
            onKeyDown("w", () => { if (!gameOver) player.move(0, -C.playerSpeed); });
            onKeyDown("s", () => { if (!gameOver) player.move(0, C.playerSpeed); });

            // Player Logic
            player.onUpdate(() => {
                // Screen clamp
                player.pos.x = clamp(player.pos.x, 20, width() - 20);
                player.pos.y = clamp(player.pos.y, 40, height() - 20);
                
                // Invulnerability flicker
                if (player.invuln > 0) {
                    player.invuln -= dt();
                    player.opacity = wave(0.3, 1, time() * 16);
                } else {
                    player.opacity = 1;
                }
            });

            // Shooting
            onUpdate(() => {
                if (gameOver) return;
                fireTimer -= dt();
                const shooting = isKeyDown("z") || isKeyDown("space");
                if (shooting && fireTimer <= 0) {
                    fireTimer = C.fireRate;
                    // Twin shot
                    for (const ox of [-12, 12]) {
                        add([
                            rect(4, 16, { radius: 2 }),
                            pos(player.pos.x + ox, player.pos.y - 20),
                            area(),
                            anchor("center"),
                            color(...C.bulletCol),
                            move(UP, C.bulletSpeed),
                            offscreen({ destroy: true }),
                            z(8),
                            "pbullet",
                        ]);
                    }
                }
            });

            // -- ENEMY SPAWNER --
            function spawnEnemy() {
                if (gameOver) return;
                const type = choose(["cloud", "cloud", "aphid", "smog"]);
                
                // Definitions
                const defs = {
                    cloud: { // Basic: Pollution Cloud
                        w: 30, h: 30, hp: 1, 
                        spd: rand(...C.enemySpeed), 
                        col: [100, 100, 100], 
                        pts: 50, shoots: false,
                        lbl: "ðŸ’¨"
                    },
                    aphid: { // Fast: Hungry Aphid
                        w: 20, h: 20, hp: 1, 
                        spd: rand(180, 280), 
                        col: [180, 200, 50], 
                        pts: 100, shoots: false,
                        lbl: "ðŸ¦—"
                    },
                    smog: { // Tank: Industrial Smog
                        w: 40, h: 40, hp: 3, 
                        spd: rand(40, 80), 
                        col: [80, 40, 100], 
                        pts: 200, shoots: true,
                        lbl: "ðŸ­"
                    },
                };
                
                const conf = defs[type];

                const e = add([
                    rect(conf.w, conf.h, { radius: 4 }),
                    pos(rand(30, width() - 30), -40),
                    area(),
                    anchor("center"),
                    color(...conf.col),
                    outline(2, BLACK),
                    z(9),
                    { 
                        hp: conf.hp, 
                        pts: conf.pts, 
                        shoots: conf.shoots, 
                        fireCD: rand(1, C.enemyFireRate),
                        type: type
                    },
                    "enemy",
                ]);
                
                // Icon label
                e.add([ text(conf.lbl, {size: 14}), anchor("center") ]);

                // Movement Logic
                if (type === "aphid") {
                    e.onUpdate(() => {
                        e.move(Math.sin(time() * 5 + e.pos.x) * 150, conf.spd);
                    });
                } else {
                    e.onUpdate(() => {
                        e.move(0, conf.spd);
                    });
                }

                // Tank Shooting
                if (conf.shoots) {
                    e.onUpdate(() => {
                        if (gameOver) return;
                        e.fireCD -= dt();
                        if (e.fireCD <= 0) {
                            e.fireCD = C.enemyFireRate;
                            add([
                                circle(6),
                                pos(e.pos),
                                area(),
                                anchor("center"),
                                color(...C.enemyBulletCol),
                                move(DOWN, C.enemyBulletSpd),
                                offscreen({ destroy: true }),
                                z(8),
                                "ebullet"
                            ]);
                        }
                    });
                }
            }

            // -- INPUT SPAWNER (Sunlight, Water, CO2) --
            function spawnInput() {
                if (gameOver) return;
                
                // Only spawn what we are missing to be helpful, or random? 
                // Random is more fun/challenging.
                const type = choose(["sunlight", "water", "co2"]);
                const conf = {
                    sunlight: { col: C.inputColors.sunlight, tag: "Sunlight", char: "S" },
                    water: { col: C.inputColors.water, tag: "Water", char: "W" },
                    co2: { col: C.inputColors.co2, tag: "CO2", char: "C" },
                }[type];

                const item = add([
                    circle(14),
                    pos(rand(40, width() - 40), -40),
                    area(),
                    anchor("center"),
                    color(...conf.col),
                    outline(2, WHITE),
                    move(DOWN, 150),
                    offscreen({ destroy: true }),
                    z(15), // Above enemies
                    "input-item",
                    conf.tag // "Sunlight", "Water", or "CO2"
                ]);

                item.add([
                    text(conf.char, { size: 14, font: "monospace" }),
                    anchor("center"),
                    color(0, 0, 0)
                ]);
            }

            // -- GLUCOSE BLAST --
            function triggerGlucoseBlast() {
                // Visuals
                shake(20);
                flash(rgb(255, 255, 255), 0.3);
                
                // Feedback Text
                const txt = add([
                    text("GLUCOSE PRODUCED!\nOXYGEN RELEASED!", { size: 24, align: "center" }),
                    pos(width()/2, height()/2),
                    anchor("center"),
                    color(255, 255, 0),
                    z(100),
                    lifespan(2, { fade: 0.5 })
                ]);

                // Destroy all enemies
                get("enemy").forEach((e) => {
                    addKaboom(e.pos);
                    score += e.pts * 2; // Bonus points
                    destroy(e);
                });
                
                // Destroy all enemy bullets
                get("ebullet").forEach((b) => {
                    addKaboom(b.pos, { scale: 0.5 });
                    destroy(b);
                });

                // Release Oxygen Particles (The Byproduct)
                for(let i=0; i<30; i++) {
                    add([
                        circle(rand(2, 6)),
                        pos(player.pos),
                        color(200, 200, 255),
                        move(rand(0, 360), rand(100, 400)),
                        opacity(0.8),
                        lifespan(1.5, { fade: 0.5 }),
                        z(20)
                    ]);
                }

                // Reset Gauge
                synthesis.sunlight = false;
                synthesis.water = false;
                synthesis.co2 = false;
                updateHUD();
            }

            // -- SPAWN LOOPS --
            loop(0.8, () => {
                if (spawnTimer <= 0) spawnEnemy();
            });
            
            // Spawn inputs every 3-5 seconds
            loop(1, () => {
                inputSpawnTimer -= dt();
                if (inputSpawnTimer <= 0) {
                    inputSpawnTimer = rand(2.5, 4.5);
                    spawnInput();
                }
            });

            // -- GAME LOOP --
            onUpdate(() => {
                if (gameOver) return;

                // Difficulty scaling
                difficulty = 1 + score / 2500;
                spawnTimer -= dt();
                if (spawnTimer <= 0) {
                    spawnTimer = C.spawnRate / difficulty;
                }

                // Background Transition (Soil -> Sky)
                // Max out at 5000 points
                const t = Math.min(score / 5000, 1);
                const c1 = rgb(...C.bgStart);
                const c2 = rgb(...C.bgEnd);
                bgRect.color = c1.lerp(c2, t);
            });

            // -- COLLISIONS --

            // 1. Player Bullets vs Enemies
            onCollide("pbullet", "enemy", (b, e) => {
                destroy(b);
                e.hp--;
                // Visual hit effect
                e.color = WHITE;
                wait(0.05, () => e.color = rgb(100, 100, 100)); // Flash white logic simplified?
                // Actually reset to original color is hard without storing it. 
                // Let's just spawn a small particle
                add([ rect(4,4), pos(b.pos), color(255,255,255), lifespan(0.1) ]);

                if (e.hp <= 0) {
                    score += e.pts;
                    addKaboom(e.pos);
                    destroy(e);
                    updateHUD();
                }
            });

            // 2. Enemy Attacks vs Player
            const hurtPlayer = () => {
                if (player.invuln > 0 || gameOver) return;
                player.hp--;
                player.invuln = 1.5;
                shake(10);
                flash(rgb(255, 80, 80), 0.1);
                updateHUD();
                
                if (player.hp <= 0) {
                    gameOver = true;
                    addKaboom(player.pos);
                    player.opacity = 0;
                    wait(1, () => go("gameover", score));
                }
            };

            onCollide("ebullet", "player", (b) => {
                destroy(b);
                hurtPlayer();
            });

            onCollide("enemy", "player", (e) => {
                addKaboom(e.pos);
                destroy(e);
                hurtPlayer();
            });

            // 3. Player vs Inputs (The Addon)
            onCollide("player", "input-item", (p, item) => {
                // Check tag
                if (item.is("Sunlight")) synthesis.sunlight = true;
                if (item.is("Water")) synthesis.water = true;
                if (item.is("CO2")) synthesis.co2 = true;

                // Feedback
                add([
                    text("Collected!", { size: 14 }),
                    pos(item.pos),
                    move(UP, 100),
                    lifespan(0.5),
                    color(255, 255, 255),
                    z(20)
                ]);
                
                destroy(item);
                updateHUD();

                // Check for Glucose Blast
                if (synthesis.sunlight && synthesis.water && synthesis.co2) {
                    triggerGlucoseBlast();
                }
            });
            
            // Cleanup offscreen enemies
            onUpdate("enemy", (e) => {
                if (e.pos.y > height() + 60) destroy(e);
            });

            // Initial HUD
            updateHUD();
        });

        // ==================
        //  GAME OVER SCENE
        // ==================
        scene("gameover", (finalScore) => {
            makeBackground(); 
            makePollen();
            
            const box = add([
                rect(320, 200, { radius: 8 }),
                pos(center()),
                anchor("center"),
                color(0, 0, 0),
                outline(4, rgb(40, 200, 40)),
                opacity(0.9)
            ]);

            add([
                text("GAME OVER", { size: 32 }), 
                pos(center().x, center().y - 40), 
                anchor("center"), 
                color(220, 60, 80)
            ]);
            
            add([
                text(`Sugar Produced: ${finalScore}`, { size: 24 }), 
                pos(center().x, center().y + 10), 
                anchor("center"), 
                color(255, 255, 200)
            ]);
            
            add([
                text("Press SPACE to retry", { size: 16 }), 
                pos(center().x, center().y + 60), 
                anchor("center"), 
                color(140, 140, 170)
            ]);

            onKeyPress("space", () => go("game"));
            onClick(() => go("game"));
        });

        // Start
        go("game");

    </script>
</body>

</html>