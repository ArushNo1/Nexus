<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Testing Lab: Knowledge Gate</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a19;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
    <script>
        /**
         * EDUCATIONAL OBJECTIVES
         * ----------------------
         * Topic: Programming Basics (Variables & Logic)
         * Mechanic: The "Knowledge Gate" requires players to answer a question to progress.
         *           - Correct Answer: Level Complete
         *           - Incorrect Answer: System Reboot (Retry Section)
         */

        // ----- 1. GAME CONFIG -----
        const CONFIG = {
            // Physics
            gravity: 1600,
            jumpForce: 650,
            moveSpeed: 300,
            maxFallSpeed: 800,

            // Player
            playerStartPos: { x: 50, y: 0 },
            playerHealth: 3,

            // Visuals - Digital/Neon Theme
            bgColor: [10, 10, 25],      // Deep Midnight
            floorColor: [0, 255, 255],  // Neon Cyan
            platformColor: [255, 0, 255], // Neon Magenta
            hazardColor: [255, 50, 50],   // Glitch Red
            coinColor: [255, 255, 0],     // Data Yellow
            gateColor: [100, 255, 100],   // Success Green (base tint)
        };

        // ----- 2. LESSON CONTENT (The Knowledge Gates) -----
        const QUESTIONS = [
            {
                q: "What stores a value?",
                a: "Variable",
                b: "Loop",
                correct: "a"
            },
            {
                q: "Which is a Boolean?",
                a: "\"True\"",
                b: "true",
                correct: "b"
            }
        ];

        // ----- 3. LEVEL MAPS -----
        // 1 = Gate A (Left), 2 = Gate B (Right)
        // Gates are placed at the end where '>' used to be.
        const LEVELS = [
            // --- Level 1 ---
            [
                "                                        ",
                "                                        ",
                "                                        ",
                "                         $   $          ",
                "                        ------          ",
                "            $  $                        ",
                "           ------           $  $        ",
                "                           ------       ",
                "    $  $                           ==== ",
                "   ------                               ",
                "                   $              1   2 ",
                "  @              =====     ===   =======",
                "========   ^^^  ========  ====== =======",
            ],
            // --- Level 2 ---
            [
                "                                        ",
                "                                        ",
                "                                        ",
                "                       $  $             ",
                "                      ------            ",
                "           $                   $        ",
                "          ---              ------       ",
                "                                     1  ",
                "    $         $     $               ==  ",
                "   ---    ------  -----            ==   ",
                "                                  == 2  ",
                "  @                              ====== ",
                "=====  ^^^  ====  ^^^  ====  ^^^ =======",
            ],
        ];

        // ----- 4. INITIALIZE KAPLAY -----
        kaplay({
            background: CONFIG.bgColor,
            width: 800,
            height: 480,
            scale: 1,
            crisp: true,
            global: true,
            letterbox: true,
            buttons: {
                jump: { keyboard: ["space", "w", "up"], gamepad: ["south"] },
                left: { keyboard: ["a", "left"], gamepad: ["dpad-left"] },
                right: { keyboard: ["d", "right"], gamepad: ["dpad-right"] },
            },
        });

        // ----- 5. ASSETS & HELPERS -----
        const TILE = 32;

        // Custom "Flash" effect for reboot
        function flashScreen() {
            const f = add([
                rect(width(), height()),
                pos(0, 0),
                color(255, 50, 50),
                opacity(0.5),
                fixed(),
                z(999),
                lifespan(0.2, { fade: 0.2 }), // Fades out over 0.2s
            ]);
        }

        // ----- 6. BUILD LEVEL -----
        function buildLevel(mapData, levelIdx) {
            const objects = { coins: [], hazards: [], platforms: [], portals: [] };
            let spawnPos = vec2(CONFIG.playerStartPos.x, CONFIG.playerStartPos.y);
            const currentQ = QUESTIONS[levelIdx] || { a: "A", b: "B", correct: "a" };

            for (let row = 0; row < mapData.length; row++) {
                for (let col = 0; col < mapData[row].length; col++) {
                    const ch = mapData[row][col];
                    const x = col * TILE;
                    const y = row * TILE;

                    switch (ch) {
                        // Ground Block (Circuitry)
                        case "=":
                            add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.floorColor),
                                outline(2, rgb(0, 0, 50)),
                                "ground",
                            ]);
                            break;

                        // One-way Platform (Hologram)
                        case "-":
                            add([
                                rect(TILE, TILE / 2),
                                pos(x, y + TILE / 2),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.platformColor),
                                opacity(0.8),
                                "platform",
                            ]);
                            break;

                        // Player Spawn
                        case "@":
                            spawnPos = vec2(x, y);
                            break;

                        // Collectible (Data Bit)
                        case "$":
                            const coin = add([
                                rect(12, 12),
                                pos(x + TILE / 2, y + TILE / 2),
                                anchor("center"),
                                area(),
                                color(...CONFIG.coinColor),
                                outline(1, rgb(255, 255, 255)),
                                rotate(45), // Diamond shape
                                z(5),
                                "coin",
                            ]);
                            // Animation: spin
                            coin.onUpdate(() => {
                                coin.angle += 2;
                            });
                            objects.coins.push(coin);
                            break;

                        // Hazard (Corrupted File)
                        case "^":
                            const hazard = add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area({ shape: new Rect(vec2(4, 4), TILE - 8, TILE - 8) }),
                                color(...CONFIG.hazardColor),
                                opacity(0.9),
                                "hazard",
                            ]);
                            // Animation: Glitch effect
                            hazard.onUpdate(() => {
                                if (rand() < 0.05) {
                                    hazard.pos.x = x + rand(-2, 2);
                                    hazard.opacity = rand(0.5, 1);
                                } else {
                                    hazard.pos.x = x;
                                }
                            });
                            break;

                        // Knowledge Gate A
                        case "1":
                            makeGate(x, y, "a", currentQ.a);
                            break;

                        // Knowledge Gate B
                        case "2":
                            makeGate(x, y, "b", currentQ.b);
                            break;
                    }
                }
            }

            // Helper to create gates
            function makeGate(x, y, type, labelText) {
                const gate = add([
                    rect(TILE, TILE * 2),
                    pos(x, y - TILE), // Sit on floor
                    area(),
                    body({ isStatic: true }), // Acts as a wall you bump into
                    color(50, 50, 80),
                    outline(2, rgb(...CONFIG.platformColor)),
                    "portal",
                    { answerType: type }, // Custom property to check answer
                ]);

                // Gate Label (A or B)
                gate.add([
                    text(type.toUpperCase(), { size: 24, font: "monospace" }),
                    pos(TILE / 2, TILE / 2),
                    anchor("center"),
                    color(255, 255, 255),
                ]);

                // Answer Text (floating above)
                add([
                    text(labelText, { size: 14, width: 200, align: "center", font: "monospace" }),
                    pos(x + TILE / 2, y - TILE - 20),
                    anchor("center"),
                    color(200, 200, 255),
                ]);
            }

            return { spawnPos, objects };
        }

        // ----- 7. MAIN GAME SCENE -----
        scene("game", (levelIdx = 0) => {
            setGravity(CONFIG.gravity);

            // Level Setup
            const { spawnPos, objects } = buildLevel(LEVELS[levelIdx], levelIdx);
            const currentQ = QUESTIONS[levelIdx] || { q: "Level Complete", correct: "a" };

            let score = 0;
            let hp = CONFIG.playerHealth;

            // --- Player Object (Data Probe) ---
            const player = add([
                rect(24, 24),
                pos(spawnPos),
                area(),
                body(),
                anchor("botleft"),
                color(0, 100, 255),
                outline(2, rgb(200, 240, 255)),
                z(10),
                { facing: 1 },
                "player",
            ]);

            // Player "Eye" (for visual direction)
            const eye = player.add([
                rect(8, 6),
                pos(14, -16),
                color(0, 255, 255),
                anchor("center"),
            ]);

            // --- HUD ---
            const hpLabel = add([
                text(`HP: ${hp}`, { size: 18, font: "monospace" }),
                pos(16, 12),
                fixed(),
                z(100),
                color(255, 50, 50),
            ]);

            const scoreLabel = add([
                text(`BITS: ${score}`, { size: 18, font: "monospace" }),
                pos(16, 36),
                fixed(),
                z(100),
                color(...CONFIG.coinColor),
            ]);

            const qLabel = add([
                text(`Q: ${currentQ.q}`, { size: 16, width: 400, align: "right", font: "monospace" }),
                pos(width() - 16, 12),
                anchor("topright"),
                fixed(),
                z(100),
                color(200, 200, 255),
            ]);

            // --- Controls ---
            onButtonDown("left", () => {
                player.move(-CONFIG.moveSpeed, 0);
                player.facing = -1;
                eye.pos.x = 8; // Move eye left
            });

            onButtonDown("right", () => {
                player.move(CONFIG.moveSpeed, 0);
                player.facing = 1;
                eye.pos.x = 16; // Move eye right
            });

            onButtonPress("jump", () => {
                if (player.isGrounded()) {
                    player.jump(CONFIG.jumpForce);
                }
            });

            // Cap fall speed
            player.onUpdate(() => {
                if (player.vel.y > CONFIG.maxFallSpeed) player.vel.y = CONFIG.maxFallSpeed;
            });

            // Camera Tracking
            player.onUpdate(() => {
                camPos(
                    lerp(camPos().x, player.pos.x + 100, 0.08),
                    lerp(camPos().y, player.pos.y - 50, 0.08),
                );
            });

            // --- Interactions ---

            // Collect Coin
            player.onCollide("coin", (coin) => {
                destroy(coin);
                score++;
                scoreLabel.text = `BITS: ${score}`;
            });

            // Hazard / Damage
            player.onCollide("hazard", () => {
                hurtPlayer();
            });

            // Fall Death
            player.onUpdate(() => {
                if (player.pos.y > LEVELS[levelIdx].length * TILE + 300) {
                    hurtPlayer();
                }
            });

            function hurtPlayer() {
                shake(5);
                hp--;
                hpLabel.text = `HP: ${hp}`;
                if (hp <= 0) {
                    go("gameover", { score, level: levelIdx });
                } else {
                    respawn();
                }
            }

            function respawn() {
                player.pos = spawnPos.clone();
                player.vel = vec2(0, 0);
                flashScreen();
            }

            // --- KNOWLEDGE GATE MECHANIC ---
            player.onCollide("portal", (portal) => {
                // Check answer
                if (portal.answerType === currentQ.correct) {
                    // Correct!
                    const nextLevel = levelIdx + 1;
                    if (nextLevel < LEVELS.length) {
                        go("game", nextLevel);
                    } else {
                        go("win", { score });
                    }
                } else {
                    // Incorrect - Reboot System
                    shake(10);
                    // Visual feedback
                    add([
                        text("SYSTEM ERROR", { size: 32, font: "monospace" }),
                        pos(center()),
                        anchor("center"),
                        fixed(),
                        color(255, 0, 0),
                        lifespan(1, { fade: 1 }),
                        opacity(1),
                    ]);
                    respawn();
                }
            });

            // Background deco (digital rain style stars)
            for (let i = 0; i < 50; i++) {
                add([
                    rect(2, rand(4, 10)),
                    pos(rand(0, width() * 4), rand(-200, height() * 2)),
                    color(0, 100, 0),
                    opacity(0.3),
                    z(-10),
                    "rain",
                ]);
            }
        });

        // ----- 8. END SCREENS -----
        scene("gameover", ({ score, level }) => {
            add([
                text("SYSTEM FAILURE", { size: 48, font: "monospace" }),
                pos(center()),
                anchor("center"),
                color(255, 50, 50),
            ]);
            add([
                text("Press SPACE to Reboot", { size: 18, font: "monospace" }),
                pos(center().x, center().y + 80),
                anchor("center"),
                color(200, 200, 200),
            ]);
            onKeyPress("space", () => go("game", level));
            onClick(() => go("game", level));
        });

        scene("win", ({ score }) => {
            add([
                text("TEST COMPLETE", { size: 48, font: "monospace" }),
                pos(center()),
                anchor("center"),
                color(100, 255, 100),
            ]);
            add([
                text(`Data Bits Collected: ${score}`, { size: 24, font: "monospace" }),
                pos(center().x, center().y + 60),
                anchor("center"),
                color(255, 255, 0),
            ]);
            add([
                text("Press SPACE to Restart", { size: 18, font: "monospace" }),
                pos(center().x, center().y + 120),
                anchor("center"),
                color(150, 150, 180),
            ]);
            onKeyPress("space", () => go("game", 0));
            onClick(() => go("game", 0));
        });

        // ----- 9. START -----
        go("game", 0);

    </script>
</body>

</html>