<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civil War: The Legislative Dispatch</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
    <script>
        // ============================================================
        //  CIVIL WAR: THE LEGISLATIVE DISPATCH
        //  A historical platformer about the causes of the US Civil War.
        //  Mechanics: Platforming + Fact Sorting Minigame
        // ============================================================

        // ----- 1. GAME CONFIG -----
        const CONFIG = {
            // Physics
            gravity: 1600,
            jumpForce: 650,
            moveSpeed: 300,
            maxFallSpeed: 800,

            // Player Stats
            playerStartPos: { x: 50, y: 0 },
            playerHealth: 3,

            // Visuals - Civil War Theme
            colors: {
                unionBlue: [0, 50, 150],
                confedGray: [130, 130, 140],
                skinTan: [210, 180, 140],
                
                // Level 1: North (Industrial)
                northSky: [100, 105, 110], // Smoggy/Overcast
                northGround: [130, 50, 50], // Brick
                
                // Level 2: South (Agrarian)
                southSky: [200, 150, 100], // Dusty/Sunset
                southGround: [100, 70, 40], // Soil

                wood: [180, 140, 100],
                scrollWhite: [245, 245, 235],
                scrollRibbon: [218, 165, 32],
                hazardIron: [60, 60, 60],
                portalMetal: [80, 80, 90],
                portalLight: [255, 255, 100],
            }
        };

        // ----- 2. HISTORICAL DATA -----
        const FACT_DATA = [
            // Level 0: The North
            {
                region: "The North",
                sky: CONFIG.colors.northSky,
                ground: CONFIG.colors.northGround,
                facts: [
                    { id: 1, text: "Economy based on manufacturing", side: "Union" },
                    { id: 2, text: "High population density", side: "Union" },
                    { id: 3, text: "extensive railroad networks", side: "Union" },
                    { id: 4, text: "Favored protective tariffs", side: "Union" } // Backup fact
                ]
            },
            // Level 1: The South
            {
                region: "The South",
                sky: CONFIG.colors.southSky,
                ground: CONFIG.colors.southGround,
                facts: [
                    { id: 5, text: "Economy based on agriculture", side: "Confederacy" },
                    { id: 6, text: "Reliant on plantation labor", side: "Confederacy" },
                    { id: 7, text: "Exported cotton to Europe", side: "Confederacy" },
                    { id: 8, text: "Opposed high tariffs", side: "Confederacy" } // Backup fact
                ]
            }
        ];

        // ----- 3. LEVEL MAPS -----
        // Adjusted to have exactly 3 scrolls ($) per level for the minigame
        const LEVELS = [
            // --- Level 1: Northern Factories ---
            [
                "                                        ",
                "                                        ",
                "                                        ",
                "                         $              ",
                "                        ------          ",
                "                                        ",
                "           ------           $           ",
                "                           ------    >  ",
                "       $                           ==== ",
                "   ------                               ",
                "                                        ",
                "  @              =====     ===          ",
                "========   ^^^  ========  ======  ======",
            ],
            // --- Level 2: Southern Plantations ---
            [
                "                                        ",
                "                                   >    ",
                "                                  ===   ",
                "                          $             ",
                "                      ------            ",
                "           $                            ",
                "          ---              ------       ",
                "                                        ",
                "              $                         ",
                "   ---    ------  -----                 ",
                "                                        ",
                "  @                          ===        ",
                "=====  ^^^  ====  ^^^  ====  ^^^^^^  ===",
            ],
        ];

        // ----- 4. INITIALIZE KAPLAY -----
        kaplay({
            width: 800,
            height: 480,
            scale: 1,
            crisp: true,
            global: true,
            letterbox: true,
            buttons: {
                jump: { keyboard: ["space", "w", "up"], gamepad: ["south"] },
                left: { keyboard: ["a", "left"], gamepad: ["dpad-left"] },
                right: { keyboard: ["d", "right"], gamepad: ["dpad-right"] },
            },
            // Default background, will be overridden per level
            background: CONFIG.colors.northSky, 
        });

        const TILE = 32;

        // ----- 5. HELPER: Build Level -----
        function buildLevel(mapData, levelIdx) {
            const levelConfig = FACT_DATA[levelIdx];
            const objects = { scrolls: [], hazards: [], platforms: [], portals: [] };
            let spawnPos = vec2(CONFIG.playerStartPos.x, CONFIG.playerStartPos.y);
            let scrollCount = 0;

            // Background for this level
            add([
                rect(width() * 2, height() * 2), // Oversized to cover camera movement
                pos(-width()/2, -height()/2),
                color(...levelConfig.sky),
                fixed(),
                z(-1000),
                "bg"
            ]);

            for (let row = 0; row < mapData.length; row++) {
                for (let col = 0; col < mapData[row].length; col++) {
                    const ch = mapData[row][col];
                    const x = col * TILE;
                    const y = row * TILE;

                    switch (ch) {
                        // Ground
                        case "=":
                            add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...levelConfig.ground),
                                outline(2, rgb(0, 0, 0)),
                                "ground",
                            ]);
                            break;

                        // Platforms (Wooden)
                        case "-":
                            add([
                                rect(TILE, TILE / 2),
                                pos(x, y + TILE / 2),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.colors.wood),
                                outline(2, rgb(40, 30, 10)),
                                "platform",
                            ]);
                            break;

                        // Player Spawn
                        case "@":
                            spawnPos = vec2(x, y);
                            break;

                        // Fact Scroll (Collectible)
                        case "$":
                            // Assign a specific fact from the level's pool
                            const factIndex = scrollCount % levelConfig.facts.length;
                            const fact = levelConfig.facts[factIndex];
                            
                            const scroll = add([
                                rect(20, 14),
                                pos(x + TILE / 2, y + TILE / 2),
                                area(),
                                anchor("center"),
                                color(...CONFIG.colors.scrollWhite),
                                outline(1, rgb(0,0,0)),
                                z(5),
                                "scroll",
                                { fact: fact } // Attach data to object
                            ]);
                            
                            // Ribbon detail
                            scroll.add([
                                rect(4, 14),
                                pos(0, 0),
                                anchor("center"),
                                color(...CONFIG.colors.scrollRibbon)
                            ]);

                            objects.scrolls.push(scroll);
                            scrollCount++;
                            break;

                        // Policy Spike (Hazard)
                        case "^":
                            add([
                                polygon([vec2(0, TILE), vec2(TILE / 2, 4), vec2(TILE, TILE)]),
                                pos(x, y),
                                area({ shape: new Rect(vec2(4, 8), TILE - 8, TILE - 8) }),
                                color(...CONFIG.colors.hazardIron),
                                "hazard",
                            ]);
                            break;

                        // Telegraph Station (Portal)
                        case ">":
                            // Tower body
                            const portal = add([
                                rect(TILE, TILE * 1.5),
                                pos(x, y - TILE * 0.5),
                                area(),
                                anchor("top"),
                                color(...CONFIG.colors.portalMetal),
                                z(1),
                                "portal",
                            ]);
                            
                            // Blinking light
                            const light = portal.add([
                                circle(6),
                                pos(TILE/2, 6),
                                color(...CONFIG.colors.portalLight),
                                opacity(0.8),
                                "portalLight"
                            ]);
                            
                            // Simple blink animation
                            loop(0.5, () => {
                                light.opacity = light.opacity === 0.8 ? 0.2 : 0.8;
                            });

                            objects.portals.push(portal);
                            break;
                    }
                }
            }
            return { spawnPos, totalScrolls: scrollCount };
        }

        // ----- 6. MAIN GAME SCENE -----
        scene("game", (levelIdx = 0) => {
            setGravity(CONFIG.gravity);

            const { spawnPos, totalScrolls } = buildLevel(LEVELS[levelIdx], levelIdx);
            
            // Game State
            let hp = CONFIG.playerHealth;
            let collectedFacts = []; // Array of fact objects

            // --- Player Object (History Scout) ---
            const player = add([
                rect(24, 32),
                pos(spawnPos),
                area(),
                body(),
                anchor("botleft"),
                color(...CONFIG.colors.unionBlue),
                outline(1, rgb(0,0,0)),
                z(10),
                "player",
            ]);

            // Face detail
            player.add([
                rect(14, 12),
                pos(12, 8),
                anchor("center"),
                color(...CONFIG.colors.skinTan)
            ]);

            // --- HUD ---
            const hpLabel = add([
                text(`Unity: ${hp}`, { size: 18, font: "monospace" }),
                pos(16, 12),
                fixed(),
                z(100),
                color(100, 200, 255),
            ]);

            const factsLabel = add([
                text(`Facts: 0/${totalScrolls}`, { size: 18, font: "monospace" }),
                pos(16, 36),
                fixed(),
                z(100),
                color(255, 215, 0),
            ]);

            add([
                text(FACT_DATA[levelIdx].region, { size: 18, font: "monospace" }),
                pos(width() - 16, 12),
                anchor("topright"),
                fixed(),
                z(100),
                color(255, 255, 255),
            ]);

            // --- Movement ---
            onButtonDown("left", () => {
                player.move(-CONFIG.moveSpeed, 0);
                player.flipX = true; // Primitive rects don't flip, but we can animate face if needed
            });

            onButtonDown("right", () => {
                player.move(CONFIG.moveSpeed, 0);
            });

            onButtonPress("jump", () => {
                if (player.isGrounded()) {
                    player.jump(CONFIG.jumpForce);
                }
            });

            player.onUpdate(() => {
                if (player.vel && player.vel.y > CONFIG.maxFallSpeed) {
                    player.vel.y = CONFIG.maxFallSpeed;
                }
            });

            // Camera
            player.onUpdate(() => {
                camPos(
                    lerp(camPos().x, player.pos.x + 100, 0.05),
                    lerp(camPos().y, player.pos.y - 50, 0.05),
                );
            });

            // --- Scroll Collection ---
            player.onCollide("scroll", (scroll) => {
                collectedFacts.push(scroll.fact);
                destroy(scroll);
                
                // Feedback
                factsLabel.text = `Facts: ${collectedFacts.length}/${totalScrolls}`;
                
                // Show floating text of what was found
                add([
                    text("Fact Found!", { size: 14 }),
                    pos(player.pos.x, player.pos.y - 40),
                    anchor("center"),
                    color(255, 255, 255),
                    move(vec2(0, -50), 30),
                    lifespan(1, { fade: 0.5 }), // Fades out
                    opacity(1),
                    z(20)
                ]);
            });

            // --- Hazards ---
            player.onCollide("hazard", () => {
                hp--;
                hpLabel.text = `Unity: ${hp}`;
                shake(6);
                if (hp <= 0) {
                    go("gameover", { level: levelIdx });
                } else {
                    player.pos = spawnPos.clone();
                    player.vel = vec2(0, 0);
                }
            });

            // --- Portal / Level Exit ---
            player.onCollide("portal", () => {
                if (collectedFacts.length >= totalScrolls) {
                    // Go to Sorting Minigame
                    go("sorting", { 
                        facts: collectedFacts, 
                        nextLevel: levelIdx + 1,
                        currentRegion: FACT_DATA[levelIdx].region
                    });
                } else {
                    // Warning message
                    const warning = add([
                        text("Collect all Facts first!", { size: 16 }),
                        pos(player.pos.x, player.pos.y - 60),
                        anchor("center"),
                        color(255, 100, 100),
                        lifespan(2, { fade: 1 }),
                        opacity(1),
                        z(100)
                    ]);
                }
            });

            // --- Fall Death ---
            player.onUpdate(() => {
                if (player.pos.y > LEVELS[levelIdx].length * TILE + 200) {
                    hp--;
                    hpLabel.text = `Unity: ${hp}`;
                    if (hp <= 0) {
                        go("gameover", { level: levelIdx });
                    } else {
                        player.pos = spawnPos.clone();
                        player.vel = vec2(0, 0);
                    }
                }
            });
        });

        // ----- 7. SORTING MINIGAME SCENE (Addon) -----
        scene("sorting", ({ facts, nextLevel, currentRegion }) => {
            // Background
            add([
                rect(width(), height()),
                color(30, 30, 40),
                fixed()
            ]);

            // Header
            add([
                text("LEGISLATIVE DISPATCH", { size: 32, font: "monospace" }),
                pos(width() / 2, 40),
                anchor("center"),
                color(255, 255, 255)
            ]);
            
            add([
                text(`Categorize facts from ${currentRegion}`, { size: 18 }),
                pos(width() / 2, 80),
                anchor("center"),
                color(200, 200, 200)
            ]);

            // Bins
            const binY = 140;
            const binWidth = 200;
            const binHeight = 250;

            // Union Bin
            add([
                rect(binWidth, binHeight),
                pos(width() * 0.25, binY),
                anchor("center"),
                color(...CONFIG.colors.unionBlue),
                outline(4, rgb(255, 255, 255)),
                "bin_union"
            ]);
            add([
                text("UNION\n(North)", { size: 24, align: "center" }),
                pos(width() * 0.25, binY - 100),
                anchor("center"),
                color(255, 255, 255)
            ]);

            // Confederacy Bin
            add([
                rect(binWidth, binHeight),
                pos(width() * 0.75, binY),
                anchor("center"),
                color(...CONFIG.colors.confedGray),
                outline(4, rgb(255, 255, 255)),
                "bin_confed"
            ]);
            add([
                text("CONFEDERACY\n(South)", { size: 24, align: "center" }),
                pos(width() * 0.75, binY - 100),
                anchor("center"),
                color(255, 255, 255)
            ]);

            // Fact Objects
            // We'll place them in the middle initially
            facts.forEach((fact, index) => {
                const factBtn = add([
                    rect(300, 40),
                    pos(width() / 2, 160 + index * 50),
                    anchor("center"),
                    color(200, 200, 200), // Default neutral color
                    area(),
                    outline(2, rgb(0,0,0)),
                    "factBtn",
                    {
                        data: fact,
                        assigned: null // null, "Union", "Confederacy"
                    }
                ]);

                factBtn.add([
                    text(fact.text, { size: 14, width: 290, align: "center" }),
                    anchor("center"),
                    color(0, 0, 0)
                ]);

                // Click interaction
                factBtn.onClick(() => {
                    // Cycle state: Neutral -> Union -> Confed -> Neutral
                    if (factBtn.assigned === null) {
                        factBtn.assigned = "Union";
                        factBtn.color = rgb(...CONFIG.colors.unionBlue);
                        factBtn.pos.x = width() * 0.25; // Move visually to bin
                    } else if (factBtn.assigned === "Union") {
                        factBtn.assigned = "Confederacy";
                        factBtn.color = rgb(...CONFIG.colors.confedGray);
                        factBtn.pos.x = width() * 0.75;
                    } else {
                        factBtn.assigned = null;
                        factBtn.color = rgb(200, 200, 200);
                        factBtn.pos.x = width() / 2;
                    }
                });
            });

            // Submit Button
            const submitBtn = add([
                rect(200, 50),
                pos(width() / 2, height() - 60),
                anchor("center"),
                area(),
                color(40, 180, 80),
                outline(2, rgb(255, 255, 255)),
                "submit"
            ]);

            submitBtn.add([
                text("SEND DISPATCH", { size: 20 }),
                anchor("center"),
                color(255, 255, 255)
            ]);

            // Validation Logic
            submitBtn.onClick(() => {
                let correct = 0;
                let allSorted = true;
                const factObjs = get("factBtn");

                factObjs.forEach(obj => {
                    if (obj.assigned === null) allSorted = false;
                    if (obj.assigned === obj.data.side) correct++;
                });

                if (!allSorted) {
                    shake(5);
                    add([
                        text("Sort all facts first!", { size: 24 }),
                        pos(width()/2, height()/2),
                        anchor("center"),
                        color(255, 100, 100),
                        lifespan(1, { fade: 0.5 }),
                        opacity(1),
                        z(200)
                    ]);
                    return;
                }

                if (correct === facts.length) {
                    // Success!
                    playSuccessEffects();
                    wait(1.5, () => {
                        if (nextLevel < LEVELS.length) {
                            go("game", nextLevel);
                        } else {
                            go("win", { score: facts.length }); // Simplified win tracking
                        }
                    });
                } else {
                    // Failure
                    shake(10);
                    add([
                        text(`Inaccuracies Detected!\n(${correct}/${facts.length} Correct)`, { size: 24, align: "center" }),
                        pos(width()/2, height()/2),
                        anchor("center"),
                        color(255, 50, 50),
                        lifespan(2, { fade: 0.5 }),
                        opacity(1),
                        z(200)
                    ]);
                }
            });
        });

        function playSuccessEffects() {
            add([
                text("DISPATCH SENT!", { size: 48 }),
                pos(center()),
                anchor("center"),
                color(50, 255, 50),
                lifespan(2, { fade: 0.5 }),
                opacity(1),
                z(200)
            ]);
            // Confetti
            for(let i=0; i<20; i++) {
                add([
                    rect(4,4),
                    pos(rand(0, width()), rand(0, height())),
                    color(rand(200,255), rand(200,255), 0),
                    move(vec2(0, 100), rand(50, 150)),
                    lifespan(2),
                    opacity(1)
                ]);
            }
        }

        // ----- 8. GAME OVER SCENE -----
        scene("gameover", ({ level }) => {
            add([
                rect(width(), height()),
                color(20, 0, 0),
            ]);
            add([
                text("HISTORY REPEATS ITSELF", { size: 48, align: "center" }),
                pos(center()),
                anchor("center"),
                color(220, 60, 80),
            ]);
            add([
                text("The Union is fractured.", { size: 20 }),
                pos(center().x, center().y + 60),
                anchor("center"),
                color(200, 200, 200),
            ]);
            add([
                text("Press SPACE to try again", { size: 18 }),
                pos(center().x, center().y + 110),
                anchor("center"),
                color(150, 150, 180),
            ]);
            onKeyPress("space", () => go("game", level));
            onClick(() => go("game", level));
        });

        // ----- 9. WIN SCENE -----
        scene("win", () => {
             add([
                rect(width(), height()),
                color(0, 40, 0),
            ]);
            add([
                text("UNION PRESERVED!", { size: 48 }),
                pos(center()),
                anchor("center"),
                color(100, 255, 150),
            ]);
            add([
                text("You successfully navigated the\nhistory of the Civil War.", { size: 20, align: "center" }),
                pos(center().x, center().y + 80),
                anchor("center"),
                color(255, 210, 50),
            ]);
            add([
                text("Press SPACE to restart history", { size: 18 }),
                pos(center().x, center().y + 150),
                anchor("center"),
                color(150, 150, 180),
            ]);
            onKeyPress("space", () => go("game", 0));
            onClick(() => go("game", 0));
        });

        // Start
        go("game", 0);

    </script>
</body>
</html>