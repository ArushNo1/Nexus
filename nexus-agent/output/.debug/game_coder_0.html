<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine's History Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/kaplay@3001.0.19/dist/kaplay.js"></script>
    <script>
        // ============================================================
        //  VALENTINE'S HISTORY MESSENGER
        //  A historical platformer using Kaplay.js primitives.
        // ============================================================

        // ----- 1. GAME DATA & CONFIG -----
        
        // Data for each historical era (Level)
        const ERA_DATA = [
            {
                name: "Ancient Rome",
                description: "Deliver secret messages during the ban on marriage.",
                bgColor: [100, 149, 237],      // Cornflower Blue (Roman Sky)
                floorColor: [245, 245, 220],   // Beige/Marble
                platformColor: [218, 165, 32], // Goldenrod (Gold accents)
                hazardColor: [178, 34, 34],    // Firebrick (Roman Soldier Red)
                artifactColor: [255, 250, 240],// FloralWhite (Scrolls)
                artifacts: [
                    { title: "Imperial Decree", desc: "Claudius II banned marriage to create better soldiers." },
                    { title: "Secret Scroll", desc: "Valentine defied the Emperor by marrying couples in secret." },
                    { title: "Jailer's Key", desc: "Valentine was imprisoned for his beliefs and kindness." }
                ]
            },
            {
                name: "Middle Ages",
                description: "Navigate the age of courtly love and poetry.",
                bgColor: [47, 79, 79],         // Dark Slate Gray (Gloomy sky)
                floorColor: [105, 105, 105],   // Dim Gray (Stone/Castle)
                platformColor: [139, 69, 19],  // Saddle Brown (Wood bridges)
                hazardColor: [0, 0, 0],        // Black (Crows/Plague)
                artifactColor: [210, 180, 140],// Tan (Parchment)
                artifacts: [
                    { title: "Chaucer's Poem", desc: "Geoffrey Chaucer first linked Valentine's Day to romance in 1382." },
                    { title: "Knight's Token", desc: "Knights gave roses to ladies during tournaments." },
                    { title: "Paper Valentine", desc: "The oldest known valentine poem was written in 1415." }
                ]
            },
            {
                name: "Industrial Era",
                description: "Mass production brings valentines to the world.",
                bgColor: [119, 136, 153],      // Light Slate Gray (Smoggy sky)
                floorColor: [85, 27, 27],      // Dark Red (Brick factories)
                platformColor: [169, 169, 169],// Dark Gray (Steel/Iron)
                hazardColor: [70, 70, 70],     // Dark Grey (Machinery)
                artifactColor: [255, 228, 225],// Misty Rose (Lace paper)
                artifacts: [
                    { title: "Factory Stamp", desc: "In the 1840s, mass-produced cards replaced handmade ones." },
                    { title: "Penny Post", desc: "Cheap postage allowed everyone to send secret valentines." },
                    { title: "Esther's Design", desc: "Esther Howland, the 'Mother of the Valentine', popularized lace cards." }
                ]
            },
            {
                name: "Modern Day",
                description: "A celebration of candy, cards, and love.",
                bgColor: [255, 192, 203],      // Pink (Love!)
                floorColor: [255, 105, 180],   // Hot Pink (Candy shop floor)
                platformColor: [255, 20, 147], // Deep Pink
                hazardColor: [255, 215, 0],    // Gold (Commercial Mascots)
                artifactColor: [220, 20, 60],  // Crimson (Heart Box)
                artifacts: [
                    { title: "Chocolate Box", desc: "Cadbury created the first heart-shaped chocolate box in 1861." },
                    { title: "Conversation Heart", desc: "These sugary treats with messages started as medical lozenges!" },
                    { title: "Greeting Card", desc: "Today, over 145 million cards are sent on Valentine's Day." }
                ]
            }
        ];

        const CONFIG = {
            // Physics
            gravity: 1600,
            jumpForce: 700,
            moveSpeed: 320,
            maxFallSpeed: 900,
            playerStartPos: { x: 50, y: 0 },
            playerHealth: 3,
            cameraFollow: true,
            // Colors (Defaults, overridden by Era Data)
            coinColor: [255, 215, 0],
            portalColor: [138, 43, 226],
        };

        // ----- 2. LEVEL MAPS (4 Levels) -----
        // @ = Start, > = Portal, $ = Artifact, ^ = Hazard, = = Ground, - = Platform
        const LEVELS = [
            // Level 0: Ancient Rome
            [
                "                                        ",
                "                                        ",
                "                                        ",
                "                      $                 ",
                "                    -----               ",
                "                                        ",
                "          $                  -----      ",
                "        -----      ^^                   ",
                "                  ====            >     ",
                "      ----                     =====    ",
                "  @             ^^     $                ",
                "=====  ====   ======  ====   ========   ",
            ],
            // Level 1: Middle Ages (Verticality)
            [
                "                                  $     ",
                "                                -----   ",
                "                     ----               ",
                "               ----           $         ",
                "            ----            -----       ",
                "      $                                 ",
                "    -----            ^^           >     ",
                "                   ======       =====   ",
                "           ^^                           ",
                "  @       ====                          ",
                "=====                                   ",
                "                                        ",
            ],
            // Level 2: Industrial Era (Precise jumps)
            [
                "                                        ",
                "                                     >  ",
                "     $                             ==== ",
                "   -----    ^^         $         ^^     ",
                "           ====      -----      ====    ",
                "                                        ",
                "       ^^         ^^                    ",
                "      ----       ----        $          ",
                "                           -----        ",
                "  @                                     ",
                "=====      ====       ====       ====   ",
            ],
            // Level 3: Modern Day (Long level)
            [
                "                                                            ",
                "                                                       >    ",
                "                                                     ====   ",
                "                          $                 $               ",
                "                       -------           -------            ",
                "           $                                                ",
                "        -------      ^^         ^^     ^^         ^^        ",
                "                   ======     ======  ======     ====       ",
                "      ^^                                                    ",
                "     ----                                                   ",
                "  @                                                         ",
                "=====       ====                                            ",
            ],
        ];

        // ----- 3. INITIALIZE KAPLAY -----
        kaplay({
            background: [0, 0, 0], // Will be set by level
            width: 800,
            height: 480,
            scale: 1,
            crisp: true,
            global: true,
            letterbox: true,
            buttons: {
                jump: { keyboard: ["space", "w", "up"], gamepad: ["south"] },
                left: { keyboard: ["a", "left"], gamepad: ["dpad-left"] },
                right: { keyboard: ["d", "right"], gamepad: ["dpad-right"] },
            },
        });

        const TILE = 32;

        // ----- 4. ASSET GENERATION & BUILD LEVEL -----
        
        function buildLevelMap(mapData, levelIdx) {
            const era = ERA_DATA[levelIdx];
            const objects = { artifacts: [], hazards: [], platforms: [], portals: [] };
            let spawnPos = vec2(CONFIG.playerStartPos.x, CONFIG.playerStartPos.y);
            let artifactCount = 0; // To track which artifact is which

            for (let row = 0; row < mapData.length; row++) {
                for (let col = 0; col < mapData[row].length; col++) {
                    const ch = mapData[row][col];
                    const x = col * TILE;
                    const y = row * TILE;

                    switch (ch) {
                        case "=": // Ground
                            add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...era.floorColor),
                                outline(2, rgb(20, 20, 20)),
                                "ground",
                            ]);
                            break;

                        case "-": // Platform
                            add([
                                rect(TILE, TILE / 2),
                                pos(x, y + TILE / 2),
                                area(),
                                body({ isStatic: true }),
                                color(...era.platformColor),
                                outline(2, rgb(20, 20, 20)),
                                "platform",
                            ]);
                            break;

                        case "@": // Spawn
                            spawnPos = vec2(x, y);
                            break;

                        case "$": // Artifact
                            // Visuals depend on era
                            let shapeComp;
                            if (levelIdx === 3) shapeComp = circle(10); // Heart/Circle for modern
                            else shapeComp = rect(20, 24); // Scroll/Paper for others

                            const artifact = add([
                                shapeComp,
                                pos(x + TILE / 2, y + TILE / 2),
                                anchor("center"),
                                area(),
                                color(...era.artifactColor),
                                outline(2, rgb(100, 100, 100)),
                                z(5),
                                // Custom property to link to description
                                { artifactIndex: artifactCount },
                                "artifact",
                            ]);
                            
                            // Add decorative ribbon/text lines
                            if (levelIdx !== 3) {
                                artifact.add([
                                    rect(12, 2),
                                    pos(0, -5),
                                    anchor("center"),
                                    color(0, 0, 0),
                                    opacity(0.3)
                                ]);
                                artifact.add([
                                    rect(12, 2),
                                    pos(0, 2),
                                    anchor("center"),
                                    color(0, 0, 0),
                                    opacity(0.3)
                                ]);
                            }

                            artifactCount++;
                            objects.artifacts.push(artifact);
                            break;

                        case "^": // Hazard
                            // Shape depends on era
                            let hazardVisual;
                            if (levelIdx === 0) {
                                // Roman: Triangle (Spear/Soldier)
                                hazardVisual = polygon([vec2(0, TILE), vec2(TILE / 2, 0), vec2(TILE, TILE)]);
                            } else if (levelIdx === 1) {
                                // Medieval: Crow (Diamond-ish)
                                hazardVisual = polygon([vec2(0, TILE/2), vec2(TILE/2, 0), vec2(TILE, TILE/2), vec2(TILE/2, TILE)]);
                            } else if (levelIdx === 2) {
                                // Industrial: Press (Rect)
                                hazardVisual = rect(TILE, TILE * 0.8);
                            } else {
                                // Modern: Mascot (Circle)
                                hazardVisual = circle(TILE / 2.5);
                            }

                            add([
                                hazardVisual,
                                pos(levelIdx === 3 ? x + TILE/2 : x, levelIdx === 3 ? y + TILE/2 : y),
                                anchor(levelIdx === 3 ? "center" : "topleft"),
                                area({ shape: new Rect(vec2(4, 8), TILE - 8, TILE - 8) }),
                                color(...era.hazardColor),
                                "hazard",
                            ]);
                            break;

                        case ">": // Portal
                            const portal = add([
                                rect(TILE, TILE * 1.5),
                                pos(x, y - TILE * 0.5),
                                area(),
                                anchor("topleft"),
                                color(...CONFIG.portalColor),
                                opacity(0.7),
                                z(1),
                                "portal",
                            ]);
                            // Swirl effect
                            portal.add([
                                circle(5),
                                pos(TILE/2, TILE*0.75),
                                color(255, 255, 255),
                                anchor("center"),
                                opacity(0.5),
                                {
                                    update() {
                                        this.pos.x = TILE/2 + Math.sin(time() * 4) * 10;
                                    }
                                }
                            ])
                            objects.portals.push(portal);
                            break;
                    }
                }
            }
            return spawnPos;
        }

        // ----- 5. HELPER FUNCTIONS -----

        // Function to create the "Messenger" player character
        function createPlayer(posVec) {
            // Parent object (container)
            const player = add([
                rect(24, 38), // Hitbox size roughly
                pos(posVec),
                area(),
                body(),
                anchor("botleft"),
                scale(1), // Used for facing direction
                color(0, 0, 0, 0), // Invisible parent, children draw the art
                z(10),
                "player",
            ]);

            // Body
            player.add([
                rect(24, 38),
                pos(0, 0),
                color(60, 100, 180), // Blue tunic/shirt
                anchor("botleft"),
            ]);

            // Head
            player.add([
                circle(10),
                pos(12, -38),
                color(255, 220, 180), // Skin
                anchor("bot"),
            ]);

            // Red Hat (Messenger Cap)
            player.add([
                rect(26, 8),
                pos(12, -46),
                color(220, 50, 50),
                anchor("bot"),
            ]);

            // Brown Satchel (Bag)
            player.add([
                rect(12, 16),
                pos(16, -20),
                color(139, 69, 19),
                anchor("center"),
            ]);

            return player;
        }

        // Pop-up for history facts
        function showHistoricalPopup(title, desc) {
            // Panel background
            const panel = add([
                rect(500, 100, { radius: 8 }),
                pos(center().x, height() - 80),
                anchor("center"),
                color(20, 20, 40),
                outline(4, rgb(255, 215, 0)),
                fixed(),
                opacity(1),
                lifespan(6, { fade: 1 }), // Disappears after 6s
                z(200)
            ]);

            // Title
            panel.add([
                text(title, { size: 20, font: "monospace" }),
                pos(0, -25),
                anchor("center"),
                color(255, 215, 0),
            ]);

            // Description
            panel.add([
                text(desc, { size: 16, width: 480, align: "center", font: "monospace" }),
                pos(0, 10),
                anchor("center"),
                color(255, 255, 255),
            ]);
        }

        // ----- 6. MAIN GAME SCENE -----
        scene("game", (levelIdx = 0) => {
            const era = ERA_DATA[levelIdx];
            
            // Set global background color for this era
            setBackground(...era.bgColor);
            setGravity(CONFIG.gravity);

            // Game State
            let artifactsCollected = 0;
            const totalArtifacts = 3;
            let hp = CONFIG.playerHealth;

            // Build Level
            const spawnPos = buildLevelMap(LEVELS[levelIdx], levelIdx);

            // Spawn Player
            const player = createPlayer(spawnPos);

            // HUD
            const hpLabel = add([
                text(`HP: ${hp}`, { size: 20, font: "monospace" }),
                pos(20, 20),
                fixed(),
                z(100),
                color(255, 50, 50),
            ]);

            const eraLabel = add([
                text(`${era.name}`, { size: 20, font: "monospace" }),
                pos(width()/2, 20),
                anchor("top"),
                fixed(),
                z(100),
                color(255, 255, 255),
            ]);

            const artifactLabel = add([
                text(`Artifacts: 0/${totalArtifacts}`, { size: 20, font: "monospace" }),
                pos(width() - 20, 20),
                anchor("topright"),
                fixed(),
                z(100),
                color(...era.artifactColor),
            ]);

            // Show Level Start Text
            const startText = add([
                text(era.name, { size: 48 }),
                pos(center()),
                anchor("center"),
                lifespan(2, { fade: 1 }),
                fixed(),
                z(150),
                color(255, 255, 255)
            ]);
            
            // Show Level Description
            wait(1, () => {
                add([
                    text(era.description, { size: 24, width: 600, align: "center" }),
                    pos(center().x, center().y + 60),
                    anchor("center"),
                    lifespan(3, { fade: 1 }),
                    fixed(),
                    z(150),
                    color(200, 200, 200)
                ]);
            });

            // --- Controls ---
            onButtonDown("left", () => {
                player.move(-CONFIG.moveSpeed, 0);
                player.scale = vec2(-1, 1); // Flip visual
            });

            onButtonDown("right", () => {
                player.move(CONFIG.moveSpeed, 0);
                player.scale = vec2(1, 1);
            });

            onButtonPress("jump", () => {
                if (player.isGrounded()) {
                    player.jump(CONFIG.jumpForce);
                }
            });

            player.onUpdate(() => {
                if (player.vel.y > CONFIG.maxFallSpeed) {
                    player.vel.y = CONFIG.maxFallSpeed;
                }
                // Camera
                if (CONFIG.cameraFollow) {
                    camPos(
                        lerp(camPos().x, player.pos.x + 100, 0.08),
                        lerp(camPos().y, player.pos.y, 0.08)
                    );
                }
                // Fall Death
                if (player.pos.y > LEVELS[levelIdx].length * TILE + 400) {
                    hurtPlayer();
                }
            });

            // --- Collisions ---

            // Artifacts
            player.onCollide("artifact", (a) => {
                destroy(a);
                artifactsCollected++;
                artifactLabel.text = `Artifacts: ${artifactsCollected}/${totalArtifacts}`;
                
                // Show Popup
                const info = era.artifacts[a.artifactIndex];
                if (info) {
                    showHistoricalPopup(info.title, info.desc);
                }
                
                // Particle effect
                for(let i=0; i<8; i++) {
                    add([
                        rect(4,4),
                        pos(a.pos),
                        color(...era.artifactColor),
                        move(rand(0, 360), rand(60, 200)),
                        lifespan(0.5, { fade: 0.5 }),
                        opacity(1)
                    ]);
                }
            });

            // Hazards
            player.onCollide("hazard", () => {
                hurtPlayer();
            });

            function hurtPlayer() {
                hp--;
                hpLabel.text = `HP: ${hp}`;
                shake(10);
                add([
                    rect(width(), height()),
                    pos(camPos().x - width()/2, camPos().y - height()/2), // Cover screen
                    color(255, 0, 0),
                    opacity(0.3),
                    lifespan(0.1),
                    z(200)
                ]);
                
                if (hp <= 0) {
                    go("gameover", { level: levelIdx, score: artifactsCollected });
                } else {
                    player.pos = spawnPos.clone();
                    player.vel = vec2(0, 0);
                }
            }

            // Portal
            player.onCollide("portal", () => {
                if (artifactsCollected >= totalArtifacts) {
                    const nextLevel = levelIdx + 1;
                    if (nextLevel < LEVELS.length) {
                        go("game", nextLevel);
                    } else {
                        go("win");
                    }
                } else {
                    // Locked feedback
                    shake(2);
                    const lockText = add([
                        text("Collect all Artifacts!", { size: 24 }),
                        pos(player.pos.x, player.pos.y - 60),
                        anchor("center"),
                        color(255, 100, 100),
                        lifespan(1, { fade: 1 }),
                        move(270, 50), // Move up
                        z(150),
                        opacity(1)
                    ]);
                }
            });
        });

        // ----- 7. MENUS -----
        
        scene("gameover", ({ level }) => {
            setBackground(20, 0, 0);
            add([
                text("HISTORY REWRITE FAILED", { size: 40, align: "center" }),
                pos(center()),
                anchor("center"),
                color(255, 50, 50),
            ]);
            add([
                text("Press SPACE to try again", { size: 20 }),
                pos(center().x, center().y + 80),
                anchor("center"),
            ]);
            onButtonPress("jump", () => go("game", level));
        });

        scene("win", () => {
            setBackground(50, 20, 80);
            add([
                text("HISTORY RESTORED!", { size: 48, align: "center" }),
                pos(center().x, center().y - 50),
                anchor("center"),
                color(255, 215, 0),
            ]);
            add([
                text("You connected the history of Valentine's Day.", { size: 20 }),
                pos(center().x, center().y + 20),
                anchor("center"),
            ]);
            add([
                text("Press SPACE to restart", { size: 18 }),
                pos(center().x, center().y + 80),
                anchor("center"),
                color(150, 150, 150),
            ]);
            onButtonPress("jump", () => go("game", 0));
        });

        // Start
        go("game", 0);

    </script>
</body>

</html>