<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Testing Lab: Logic Quest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a19;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <!-- JSDoc Header: Educational Objectives -->
    <script>
        /**
         * LESSON: Software Testing & Logic Gates
         * 
         * OBJECTIVES:
         * 1. Navigate a "Test Environment" (Platformer Levels).
         * 2. Collect "Data Packets" (Score) and maintain "Integrity" (HP).
         * 3. Validate system state using Logic Gates at the end of each phase.
         * 
         * MECHANICS:
         * - Run/Jump: Standard platforming controls.
         * - Logic Gates: Evaluate a boolean condition (e.g., "PACKETS > 5?") and choose the correct door.
         * - Dynamic Validation: The correct door depends on your gameplay performance.
         */
    </script>

    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
    <script>
        // ============================================================
        //  VIRTUAL TESTING LAB
        // ============================================================

        // ----- 1. GAME CONFIG -----
        const CONFIG = {
            // Physics
            gravity: 1600,
            jumpForce: 650,
            moveSpeed: 300,
            maxFallSpeed: 800,

            // Player
            playerStartPos: { x: 50, y: 0 },
            playerHealth: 3,

            // Camera
            cameraFollow: true,

            // Visuals (Neon/Cyberpunk Palette)
            bgColor: [10, 10, 25],          // Deep Midnight Blue
            floorColor: [40, 60, 100],      // Steel Blue
            platformColor: [0, 200, 200],   // Cyan
            hazardColor: [255, 0, 100],     // Neon Magenta
            coinColor: [255, 255, 0],       // Bright Yellow
            portalColor: [150, 0, 255],     // Electric Purple
            doorColor: [100, 100, 255],     // Door Blue
        };

        // ----- 2. LOGIC DATA -----
        // Defines the puzzle for each level.
        const LOGIC_DATA = [
            {
                prompt: "PACKETS > 5?",
                options: ["TRUE", "FALSE"],
                // Check if collected coins > 5
                check: (score, hp) => score > 5
            },
            {
                prompt: "INTEGRITY == 3?",
                options: ["YES", "NO"],
                // Check if HP is full (3)
                check: (score, hp) => hp === 3
            },
        ];

        // ----- 3. LEVEL MAPS -----
        // Modified to ensure space for double doors at the end.
        const LEVELS = [
            // --- Level 1 ---
            [
                "                                        ",
                "                                        ",
                "                                        ",
                "                         $   $          ",
                "                        ------          ",
                "            $  $                        ",
                "           ------           $  $        ",
                "                           ------       ",
                "    $  $                           ==== ",
                "   ------                               ",
                "                   $                    ",
                "  @              =====     ===      >   ",
                "========   ^^^  ========  ======  ======",
            ],
            // --- Level 2 ---
            [
                "                                        ",
                "                                        ",
                "                                      > ",
                "                       $  $          ===",
                "                      ------            ",
                "           $                   $        ",
                "          ---              ------       ",
                "                                        ",
                "    $         $     $                   ",
                "   ---    ------  -----                 ",
                "                                        ",
                "  @                          ===        ",
                "=====  ^^^  ====  ^^^  ====  ^^^^^^  ===",
            ],
        ];

        // ----- 4. INITIALIZE KAPLAY -----
        kaplay({
            background: CONFIG.bgColor,
            width: 800,
            height: 480,
            scale: 1,
            crisp: true,
            global: true,
            buttons: {
                jump: { keyboard: ["space", "w", "up"], gamepad: ["south"] },
                left: { keyboard: ["a", "left"], gamepad: ["dpad-left"] },
                right: { keyboard: ["d", "right"], gamepad: ["dpad-right"] },
            },
        });

        // ----- 5. TILE SIZE -----
        const TILE = 32;

        // ----- 6. HELPER: Build Level -----
        // Now accepts levelIdx to configure the specific logic doors for this level
        function buildLevel(mapData, levelIdx) {
            const objects = { coins: [], hazards: [], platforms: [], doors: [] };
            let spawnPos = vec2(CONFIG.playerStartPos.x, CONFIG.playerStartPos.y);

            // Access logic data for this level
            const currentLogic = LOGIC_DATA[levelIdx] || LOGIC_DATA[0];

            for (let row = 0; row < mapData.length; row++) {
                for (let col = 0; col < mapData[row].length; col++) {
                    const ch = mapData[row][col];
                    const x = col * TILE;
                    const y = row * TILE;

                    switch (ch) {
                        // Ground Block (Circuit Board Style)
                        case "=":
                            add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.floorColor),
                                outline(1, rgb(0, 200, 200)), // Circuit outline
                                "ground",
                            ]);
                            break;

                        // One-way Platform
                        case "-":
                            add([
                                rect(TILE, TILE / 2),
                                pos(x, y + TILE / 2),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.platformColor),
                                outline(1, rgb(0, 50, 50)),
                                "platform",
                            ]);
                            break;

                        // Player Spawn
                        case "@":
                            spawnPos = vec2(x, y);
                            break;

                        // Collectible (Data Packet)
                        case "$":
                            const packet = add([
                                rect(18, 22, { radius: 2 }),
                                pos(x + TILE / 2, y + TILE / 2),
                                anchor("center"),
                                area(),
                                color(...CONFIG.coinColor),
                                outline(2, rgb(0, 0, 0)),
                                z(5),
                                "coin",
                            ]);
                            // Add "101" text to look like data
                            packet.add([
                                text("101", { size: 8 }),
                                anchor("center"),
                                color(0, 0, 0),
                            ]);
                            objects.coins.push(packet);
                            break;

                        // Hazard (Code Bug)
                        case "^":
                            // Floating Bug Enemy
                            const bug = add([
                                // Diamond shape
                                polygon([vec2(-10, 0), vec2(0, -10), vec2(10, 0), vec2(0, 10)]),
                                pos(x + TILE / 2, y + TILE / 2),
                                anchor("center"),
                                area({ shape: new Polygon([vec2(-8, 0), vec2(0, -8), vec2(8, 0), vec2(0, 8)]) }),
                                color(...CONFIG.hazardColor),
                                outline(1, rgb(255, 255, 255)),
                                "hazard",
                                "bug", // Tag for movement logic
                                { startY: y + TILE / 2 } // Remember spawn Y
                            ]);
                            break;

                        // Level Exit (Logic Gates)
                        case ">":
                            // Spawn two doors instead of one portal
                            // Door 1 (Left) - Option 0
                            add([
                                rect(40, 64),
                                pos(x - 24, y - 32),
                                area(),
                                color(...CONFIG.portalColor),
                                outline(2, rgb(255, 255, 255)),
                                anchor("bot"),
                                "door",
                                { value: 0 } // Represents index 0 in options
                            ]).add([
                                text(currentLogic.options[0], { size: 10 }),
                                pos(0, -40),
                                anchor("center"),
                                color(255, 255, 255)
                            ]);

                            // Door 2 (Right) - Option 1
                            add([
                                rect(40, 64),
                                pos(x + 56, y - 32),
                                area(),
                                color(...CONFIG.portalColor),
                                outline(2, rgb(255, 255, 255)),
                                anchor("bot"),
                                "door",
                                { value: 1 } // Represents index 1 in options
                            ]).add([
                                text(currentLogic.options[1], { size: 10 }),
                                pos(0, -40),
                                anchor("center"),
                                color(255, 255, 255)
                            ]);
                            break;
                    }
                }
            }
            return { spawnPos };
        }

        // ----- 7. MAIN GAME SCENE -----
        scene("game", (levelIdx = 0) => {
            setGravity(CONFIG.gravity);

            // Setup Level
            const { spawnPos } = buildLevel(LEVELS[levelIdx], levelIdx);
            const currentLogic = LOGIC_DATA[levelIdx] || LOGIC_DATA[0];

            let score = 0;
            let hp = CONFIG.playerHealth;

            // --- Player (QA Drone) ---
            const player = add([
                rect(24, 24, { radius: 4 }), // Drone Body
                pos(spawnPos),
                area(),
                body(),
                anchor("botleft"),
                scale(1),
                color(200, 200, 220),
                outline(2, rgb(0, 255, 255)),
                z(10),
                { facing: 1 },
                "player",
            ]);

            // Drone Eye
            const eye = player.add([
                rect(16, 6),
                pos(12, -16),
                anchor("center"),
                color(0, 255, 255),
            ]);

            // --- HUD ---
            const hpLabel = add([
                text(`INTEGRITY: ${hp}`, { size: 16, font: "monospace" }),
                pos(16, 12),
                fixed(),
                z(100),
                color(255, 100, 100),
            ]);

            const scoreLabel = add([
                text(`PACKETS: ${score}`, { size: 16, font: "monospace" }),
                pos(16, 36),
                fixed(),
                z(100),
                color(...CONFIG.coinColor),
            ]);

            // Logic Prompt Display (Top Center)
            add([
                text(`TEST_PHASE: ${levelIdx + 1}`, { size: 14 }),
                pos(width() / 2, 16),
                anchor("top"),
                fixed(),
                color(100, 100, 255)
            ]);
            
            add([
                text(currentLogic.prompt, { size: 20 }),
                pos(width() / 2, 40),
                anchor("top"),
                fixed(),
                color(255, 255, 255)
            ]);

            // --- Movement ---
            onButtonDown("left", () => {
                player.move(-CONFIG.moveSpeed, 0);
                player.facing = -1;
                eye.pos.x = 8; // Move eye left relative to center
            });

            onButtonDown("right", () => {
                player.move(CONFIG.moveSpeed, 0);
                player.facing = 1;
                eye.pos.x = 16; // Move eye right
            });

            onButtonPress("jump", () => {
                if (player.isGrounded()) {
                    player.jump(CONFIG.jumpForce);
                }
            });

            // --- Bug Animation ---
            onUpdate("bug", (b) => {
                // Sine wave floating movement
                b.pos.y = b.startY + Math.sin(time() * 5) * 10;
            });

            // Camera Follow
            if (CONFIG.cameraFollow) {
                player.onUpdate(() => {
                    camPos(
                        lerp(camPos().x, player.pos.x + 100, 0.05),
                        lerp(camPos().y, player.pos.y - 50, 0.05),
                    );
                    // Prevent falling through map forever
                    if (player.pos.y > 1000) {
                        hurtPlayer();
                    }
                });
            }

            // --- Interactions ---

            // Collect Data Packet
            player.onCollide("coin", (coin) => {
                destroy(coin);
                score++;
                scoreLabel.text = `PACKETS: ${score}`;
                // Small visual pop
                add([
                    text("+1", { size: 12 }),
                    pos(coin.pos),
                    color(...CONFIG.coinColor),
                    move(vec2(0, -100), 50),
                    lifespan(0.5, { fade: 0.5 })
                ]);
            });

            // Hit Hazard (Bug)
            player.onCollide("hazard", () => {
                hurtPlayer();
            });

            function hurtPlayer() {
                hp--;
                hpLabel.text = `INTEGRITY: ${hp}`;
                shake(10);
                
                if (hp <= 0) {
                    go("gameover", { score, level: levelIdx });
                } else {
                    player.pos = spawnPos.clone();
                    player.vel = vec2(0, 0);
                    // Flash red
                    const flashOverlay = add([
                        rect(width(), height()),
                        fixed(),
                        color(255, 0, 0),
                        opacity(0.3),
                        lifespan(0.1, { fade: 0.1 })
                    ]);
                }
            }

            // --- Logic Door Interaction ---
            player.onCollide("door", (door) => {
                // Evaluate the logic condition based on current stats
                const isConditionTrue = currentLogic.check(score, hp);
                
                // Map boolean result to the correct door index (0 for True/Yes, 1 for False/No)
                // Assuming options[0] is the affirmative answer
                const correctIndex = isConditionTrue ? 0 : 1;

                if (door.value === correctIndex) {
                    // CORRECT!
                    const nextLevel = levelIdx + 1;
                    if (nextLevel < LEVELS.length) {
                        go("game", nextLevel);
                    } else {
                        go("win", { score });
                    }
                } else {
                    // WRONG!
                    shake(20);
                    add([
                        text("LOGIC ERROR", { size: 48 }),
                        pos(width()/2, height()/2),
                        anchor("center"),
                        fixed(),
                        color(255, 0, 0),
                        lifespan(1)
                    ]);
                    // Penalize or Reset? Let's reset the level to reinforce learning
                    wait(1, () => {
                        go("game", levelIdx);
                    });
                }
            });

            // Background Decor (Digital Rain / Stars)
            for (let i = 0; i < 30; i++) {
                add([
                    rect(2, rand(4, 10)),
                    pos(rand(0, width() * 2), rand(-200, height())),
                    color(0, 255, 100),
                    opacity(rand(0.1, 0.3)),
                    z(-10),
                    fixed(), // Make them move with camera in a parallax way if we didn't use fixed...
                             // actually let's not fix them so they scroll
                    "bg_particle"
                ]);
            }
        });

        // ----- 8. END SCENES -----
        scene("gameover", ({ score, level }) => {
            add([
                text("SYSTEM FAILURE", { size: 48 }),
                pos(center()),
                anchor("center"),
                color(255, 0, 100),
            ]);
            add([
                text(`Packets Recovered: ${score}`, { size: 24 }),
                pos(center().x, center().y + 60),
                anchor("center"),
            ]);
            add([
                text("Press SPACE to Reboot", { size: 18 }),
                pos(center().x, center().y + 120),
                anchor("center"),
                color(100, 200, 200),
            ]);
            onKeyPress("space", () => go("game", level));
        });

        scene("win", ({ score }) => {
            add([
                text("TEST SUITE PASSED", { size: 48 }),
                pos(center()),
                anchor("center"),
                color(100, 255, 100),
            ]);
            add([
                text(`Total Data: ${score}`, { size: 24 }),
                pos(center().x, center().y + 60),
                anchor("center"),
            ]);
            add([
                text("All Logic Gates Validated", { size: 18 }),
                pos(center().x, center().y + 100),
                anchor("center"),
                color(150, 150, 255),
            ]);
            add([
                text("Press SPACE to Restart", { size: 18 }),
                pos(center().x, center().y + 160),
                anchor("center"),
            ]);
            onKeyPress("space", () => go("game", 0));
        });

        // ----- 9. START -----
        go("game", 0);

    </script>
</body>

</html>