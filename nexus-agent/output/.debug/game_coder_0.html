<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civil War Chronicles: The Union Advance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #2d374b;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <!-- KAPLAY.JS CDN -->
    <script src="https://unpkg.com/kaplay@3001.0.19/dist/kaplay.js"></script>
    
    <script>
        /**
         * CIVIL WAR CHRONICLES: THE UNION ADVANCE
         * 
         * Educational Objectives:
         * 1. Identify key causes of the American Civil War (States' Rights vs. Slavery).
         * 2. Recognize major factions and leaders (Union/Lincoln vs. Confederacy/Davis).
         * 3. Understand the chronological progression of the war through level advancement.
         * 
         * Mechanics:
         * - Platformer gameplay representing the Union Army's advance.
         * - "Historical Fact Gates": Players must choose the correct historical statement to clear obstacles.
         * - "Skirmishes": Incorrect answers spawn enemies, reinforcing learning through penalty.
         */

        // ============================================================
        //  1. GAME CONFIG
        // ============================================================
        const CONFIG = {
            // Physics
            gravity: 1600,
            jumpForce: 650,
            moveSpeed: 300,
            maxFallSpeed: 800,

            // Player
            playerStartPos: { x: 50, y: 0 },
            playerHealth: 3,

            // Camera
            cameraFollow: true,

            // Visuals (Civil War Palette)
            bgColor: [45, 55, 75],       // Somber Dusk Blue
            floorColor: [101, 67, 33],   // Earthy Brown (Mud/Dirt)
            platformColor: [139, 69, 19],// Weathered Wood (Barricades)
            hazardColor: [80, 80, 80],   // Iron/Steel (Spikes/Cannons)
            coinColor: [245, 245, 220],  // Parchment (Pamphlets)
            portalColor: [0, 50, 100],   // Union Blue base for flag
            textColor: [255, 255, 255],
        };

        // ============================================================
        //  2. HISTORICAL DATA (Addon Feature)
        // ============================================================
        const FACTS = [
            {
                q: "Primary cause of the war?",
                options: ["Expansion of Trade", "Slavery"],
                correct: 1 // Index of correct option
            },
            {
                q: "President of the Union?",
                options: ["Abraham Lincoln", "Jefferson Davis"],
                correct: 0
            },
            {
                q: "The Emancipation Proclamation...",
                options: ["Ended the war", "Freed slaves in rebel states"],
                correct: 1
            }
        ];

        // ============================================================
        //  3. LEVEL MAPS
        //  New Symbols:
        //  | : Gate (Blocks path)
        //  [ : Left Banner (Option 0)
        //  ] : Right Banner (Option 1)
        // ============================================================
        const LEVELS = [
            // --- Level 1: The Outbreak ---
            [
                "                                          ",
                "                                          ",
                "                                          ",
                "                       $                  ",
                "      [              -----           ]    ",
                "    -----                          -----  ",
                "                                          ",
                "            |              |              ",
                "    $       |      $       |         >    ",
                "   ---      |     ---      |        ===   ",
                "            |              |              ",
                "  @         |              |              ",
                "=====  ^^^  =  ^^^    ^^^  =  ^^^  =======",
            ],
            // --- Level 2: The Turning Point ---
            [
                "                                          ",
                "                                          ",
                "     [           ]                        ",
                "   -----       -----                      ",
                "                                          ",
                "          |                               ",
                "          |                               ",
                "          |              [           ]    ",
                "          |            -----       -----  ",
                "     $    |                               ",
                "   -----  |                   |           ",
                "          |                   |      >    ",
                "  @       |    ^^^       $    |     ===   ",
                "=====  ^^^^^^  ====  ^^^^^^^  =  ^^^^^^^^^",
            ],
        ];

        // ============================================================
        //  4. INITIALIZE KAPLAY
        // ============================================================
        kaplay({
            background: CONFIG.bgColor,
            width: 800,
            height: 480,
            scale: 1,
            crisp: true,
            global: true,
            letterbox: true,
            buttons: {
                jump: { keyboard: ["space", "w", "up"], gamepad: ["south"] },
                left: { keyboard: ["a", "left"], gamepad: ["dpad-left"] },
                right: { keyboard: ["d", "right"], gamepad: ["dpad-right"] },
            },
        });

        const TILE = 32;

        // ============================================================
        //  5. HELPER: Build Level
        // ============================================================
        function buildLevel(mapData, levelIdx) {
            const objects = { coins: [], hazards: [], portals: [], gates: [], banners: [] };
            let spawnPos = vec2(CONFIG.playerStartPos.x, CONFIG.playerStartPos.y);
            
            // Track which Fact Gate we are currently building
            // We assume a strictly ordered layout: [ ... ] ... | 
            // Every time we place a Gate |, we increment the index for the next set.
            let currentGateIdx = levelIdx * 2; // Offset facts by level to keep them unique per level (approx)
            if (currentGateIdx >= FACTS.length) currentGateIdx = 0; // fallback

            for (let row = 0; row < mapData.length; row++) {
                for (let col = 0; col < mapData[row].length; col++) {
                    const ch = mapData[row][col];
                    const x = col * TILE;
                    const y = row * TILE;

                    switch (ch) {
                        // Ground Block (Dirt)
                        case "=":
                            add([
                                rect(TILE, TILE),
                                pos(x, y),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.floorColor),
                                outline(2, rgb(60, 40, 20)),
                                "ground",
                            ]);
                            break;

                        // Platform (Wood)
                        case "-":
                            add([
                                rect(TILE, TILE / 2),
                                pos(x, y + TILE / 2),
                                area(),
                                body({ isStatic: true }),
                                color(...CONFIG.platformColor),
                                outline(2, rgb(80, 40, 10)),
                                "platform",
                            ]);
                            break;

                        // Player Spawn
                        case "@":
                            spawnPos = vec2(x, y);
                            break;

                        // Collectible (Abolitionist Pamphlet)
                        case "$":
                            // Paper sheet visual
                            const coin = add([
                                rect(18, 24),
                                pos(x + TILE / 2, y + TILE / 2),
                                area(),
                                anchor("center"),
                                color(...CONFIG.coinColor),
                                outline(1, rgb(100, 100, 100)),
                                "coin",
                            ]);
                            // Text lines on paper
                            coin.add([
                                rect(12, 2), pos(0, -6), anchor("center"), color(0,0,0,0.3)
                            ]);
                            coin.add([
                                rect(12, 2), pos(0, 0), anchor("center"), color(0,0,0,0.3)
                            ]);
                            coin.add([
                                rect(8, 2), pos(-2, 6), anchor("center"), color(0,0,0,0.3)
                            ]);
                            objects.coins.push(coin);
                            break;

                        // Hazard (Iron Spikes)
                        case "^":
                            add([
                                polygon([vec2(0, TILE), vec2(TILE / 2, 4), vec2(TILE, TILE)]),
                                pos(x, y),
                                area({ shape: new Rect(vec2(4, 12), TILE - 8, TILE - 12) }),
                                color(...CONFIG.hazardColor),
                                "hazard",
                            ]);
                            break;

                        // Exit Portal (Union Flagpole)
                        case ">":
                            // Pole
                            const pole = add([
                                rect(4, TILE * 3),
                                pos(x + 14, y - TILE * 2),
                                area(),
                                color(200, 200, 200),
                                "portal",
                                z(5)
                            ]);
                            // Flag
                            pole.add([
                                rect(40, 24),
                                pos(2, 2),
                                color(0, 35, 102), // Union Blue
                            ]);
                            pole.add([
                                rect(40, 4),
                                pos(2, 6),
                                color(200, 0, 0), // Red stripe
                            ]);
                             pole.add([
                                rect(40, 4),
                                pos(2, 16),
                                color(200, 0, 0), // Red stripe
                            ]);
                            break;

                        // --- ADDON: HISTORICAL FACT GATES ---

                        // Gate (Barrier)
                        case "|":
                            add([
                                rect(16, TILE * 4), // Tall gate
                                pos(x + 8, y - TILE * 3),
                                area(),
                                body({ isStatic: true }),
                                color(30, 30, 30),
                                outline(2, rgb(100, 100, 100)),
                                "gate",
                                { gateId: currentGateIdx } // Link to fact
                            ]);
                            // After placing a gate, we assume the next set of banners belongs to the next fact
                            currentGateIdx++;
                            if (currentGateIdx >= FACTS.length) currentGateIdx = 0;
                            break;

                        // Left Banner (Option 0)
                        case "[":
                            const factIdxL = currentGateIdx;
                            const bannerL = add([
                                rect(140, 90),
                                pos(x, y - 40),
                                area(), 
                                anchor("center"),
                                color(220, 220, 200),
                                outline(4, rgb(139, 69, 19)),
                                "banner",
                                { factId: factIdxL, optionId: 0 }
                            ]);
                            // Banner Text
                            bannerL.add([
                                text(FACTS[factIdxL].options[0], { size: 14, width: 130, align: "center" }),
                                anchor("center"),
                                color(0, 0, 0)
                            ]);
                            // Question Text (Floating above)
                            add([
                                text(FACTS[factIdxL].q, { size: 14, width: 250, align: "center" }),
                                pos(x + TILE, y - 100), // Centered roughly between banners
                                anchor("center"),
                                color(255, 255, 255)
                            ]);
                            break;

                        // Right Banner (Option 1)
                        case "]":
                            const factIdxR = currentGateIdx;
                            const bannerR = add([
                                rect(140, 90),
                                pos(x, y - 40),
                                area(),
                                anchor("center"),
                                color(220, 220, 200),
                                outline(4, rgb(139, 69, 19)),
                                "banner",
                                { factId: factIdxR, optionId: 1 }
                            ]);
                             // Banner Text
                             bannerR.add([
                                text(FACTS[factIdxR].options[1], { size: 14, width: 130, align: "center" }),
                                anchor("center"),
                                color(0, 0, 0)
                            ]);
                            break;
                    }
                }
            }

            return { spawnPos };
        }

        // ============================================================
        //  6. MAIN GAME SCENE
        // ============================================================
        scene("game", (levelIdx = 0) => {
            setGravity(CONFIG.gravity);

            // Track solved facts to prevent re-triggering
            const solvedFacts = new Set();

            // Build Level
            const { spawnPos } = buildLevel(LEVELS[levelIdx], levelIdx);

            // UI State
            let score = 0;
            let hp = CONFIG.playerHealth;

            // --- Player Object (Union Soldier) ---
            const player = add([
                rect(24, 40), // Soldier shape
                pos(spawnPos),
                area(),
                body(),
                anchor("botleft"),
                color(0, 35, 102), // Union Blue Coat
                outline(1, rgb(0, 0, 0)),
                z(10),
                { facing: 1 },
                "player",
            ]);

            // Player details (Belt buckle)
            player.add([
                rect(24, 4),
                pos(0, -18),
                color(0, 0, 0), // Belt
                anchor("botleft")
            ]);
            player.add([
                rect(6, 6),
                pos(9, -19),
                color(218, 165, 32), // Gold Buckle
                anchor("botleft")
            ]);

            // --- HUD ---
            const uiBox = add([
                rect(width(), 40),
                fixed(),
                pos(0,0),
                color(0, 0, 0),
                opacity(0.5),
                z(99)
            ]);

            const hpLabel = add([
                text(`MORALE: ${hp}`, { size: 18 }),
                pos(16, 12),
                fixed(),
                z(100),
                color(255, 255, 255),
            ]);

            const scoreLabel = add([
                text(`PAMPHLETS: ${score}`, { size: 18 }),
                pos(16, 40),
                fixed(),
                z(100),
                color(...CONFIG.coinColor),
            ]);

            const levelLabel = add([
                text(`Section ${levelIdx + 1}`, { size: 18 }),
                pos(width() - 16, 12),
                anchor("topright"),
                fixed(),
                z(100),
                color(200, 200, 255),
            ]);

            // --- Movement ---
            onButtonDown("left", () => {
                player.move(-CONFIG.moveSpeed, 0);
                player.facing = -1;
            });

            onButtonDown("right", () => {
                player.move(CONFIG.moveSpeed, 0);
                player.facing = 1;
            });

            onButtonPress("jump", () => {
                if (player.isGrounded()) {
                    player.jump(CONFIG.jumpForce);
                }
            });

            player.onUpdate(() => {
                if (player.vel.y > CONFIG.maxFallSpeed) {
                    player.vel.y = CONFIG.maxFallSpeed;
                }
            });

            // --- Camera ---
            if (CONFIG.cameraFollow) {
                player.onUpdate(() => {
                    camPos(
                        lerp(camPos().x, player.pos.x + 100, 0.05),
                        lerp(camPos().y, player.pos.y - 50, 0.05),
                    );
                });
            }

            // --- Collection ---
            player.onCollide("coin", (coin) => {
                destroy(coin);
                score++;
                scoreLabel.text = `PAMPHLETS: ${score}`;
                // Particle puff
                for (let i = 0; i < 4; i++) {
                    add([
                        rect(4, 4),
                        pos(coin.pos),
                        color(255, 255, 200),
                        move(rand(0, 360), rand(50, 150)),
                        opacity(1),
                        lifespan(0.3, { fade: 0.3 }),
                    ]);
                }
            });

            // --- Hazards ---
            player.onCollide("hazard", () => {
                takeDamage();
            });

            player.onCollide("enemy", (e) => {
                destroy(e);
                takeDamage();
            });

            function takeDamage() {
                hp--;
                hpLabel.text = `MORALE: ${hp}`;
                flash(rgb(255, 0, 0), 0.15);
                shake(10);
                // Knockback
                player.jump(300);
                player.move(player.facing * -500, 0);

                if (hp <= 0) {
                    go("gameover", { score, level: levelIdx });
                }
            }

            // --- ADDON: HISTORICAL FACT GATES LOGIC ---
            player.onCollide("banner", (banner) => {
                // If this gate is already solved, ignore
                if (solvedFacts.has(banner.factId)) return;

                const fact = FACTS[banner.factId];
                
                // Check answer
                if (banner.optionId === fact.correct) {
                    // CORRECT
                    solvedFacts.add(banner.factId);
                    
                    // Destroy the associated Gate(s)
                    const gates = get("gate");
                    gates.forEach(g => {
                        if (g.gateId === banner.factId) {
                            destroy(g);
                            // Visual effect for gate destruction
                            for(let i=0; i<10; i++) {
                                add([
                                    rect(8, 8),
                                    pos(g.pos.add(rand(0, 16), rand(0, 100))),
                                    color(100, 100, 100),
                                    move(rand(0, 360), 100),
                                    opacity(1),
                                    lifespan(0.5, { fade: 0.5 })
                                ]);
                            }
                        }
                    });

                    // Bonus Score
                    score += 5;
                    scoreLabel.text = `PAMPHLETS: ${score}`;
                    
                    // Feedback
                    add([
                        text("CORRECT!", { size: 24 }),
                        pos(player.pos.x, player.pos.y - 60),
                        anchor("center"),
                        color(0, 255, 0),
                        move(270, 50),
                        opacity(1),
                        lifespan(1, { fade: 0.5 })
                    ]);

                } else {
                    // INCORRECT
                    shake(5);
                    add([
                        text("INCORRECT!", { size: 24 }),
                        pos(player.pos.x, player.pos.y - 60),
                        anchor("center"),
                        color(255, 0, 0),
                        move(270, 50),
                        opacity(1),
                        lifespan(1, { fade: 0.5 })
                    ]);
                    
                    // Spawn Skirmish Enemy
                    const enemy = add([
                        rect(24, 24),
                        pos(player.pos.x + 200, player.pos.y - 100),
                        area(),
                        body(),
                        color(150, 20, 20), // Confederate Red/Grey
                        "enemy",
                        "hazard"
                    ]);
                    // Simple AI: Move left
                    enemy.onUpdate(() => {
                        enemy.move(-150, 0);
                    });
                }
            });


            // --- Level Completion ---
            player.onCollide("portal", () => {
                const nextLevel = levelIdx + 1;
                if (nextLevel < LEVELS.length) {
                    go("game", nextLevel);
                } else {
                    go("win", { score });
                }
            });

            // --- Death Plane ---
            player.onUpdate(() => {
                if (player.pos.y > 1000) {
                    hp--;
                    hpLabel.text = `MORALE: ${hp}`;
                    if (hp <= 0) {
                        go("gameover", { score, level: levelIdx });
                    } else {
                        player.pos = spawnPos.clone();
                        player.vel = vec2(0, 0);
                    }
                }
            });
        });

        // ============================================================
        //  7. GAME OVER & WIN SCENES
        // ============================================================
        scene("gameover", ({ score, level }) => {
            add([
                text("RETREAT!", { size: 48 }),
                pos(center()),
                anchor("center"),
                color(220, 60, 80),
            ]);
            add([
                text(`Pamphlets Collected: ${score}`, { size: 22 }),
                pos(center().x, center().y + 60),
                anchor("center"),
                color(200, 200, 200),
            ]);
            add([
                text("Press SPACE to Regroup", { size: 18 }),
                pos(center().x, center().y + 110),
                anchor("center"),
                color(150, 150, 180),
            ]);
            onKeyPress("space", () => go("game", level));
            onClick(() => go("game", level));
        });

        scene("win", ({ score }) => {
            add([
                text("VICTORY!", { size: 48 }),
                pos(center()),
                anchor("center"),
                color(100, 255, 150),
            ]);
            add([
                text("The Union is Preserved.", { size: 24 }),
                pos(center().x, center().y + 50),
                anchor("center"),
                color(200, 200, 255),
            ]);
            add([
                text(`Total Pamphlets: ${score}`, { size: 22 }),
                pos(center().x, center().y + 100),
                anchor("center"),
                color(255, 210, 50),
            ]);
            add([
                text("Press SPACE to Play Again", { size: 18 }),
                pos(center().x, center().y + 150),
                anchor("center"),
                color(150, 150, 180),
            ]);
            onKeyPress("space", () => go("game", 0));
            onClick(() => go("game", 0));
        });

        // Start Game
        go("game", 0);

    </script>
</body>

</html>