<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Photosynthesis Run - Chloroplast Charge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            background: #142814; /* Deep Forest Green */
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/kaplay@3001/dist/kaplay.js"></script>
    <script>
        /**
         * PHOTOSYNTHESIS RUN - CHLOROPLAST CHARGE (FIXED)
         * 
         * A revised version of the quiz runner template with "Chloroplast Charge" addon.
         * 
         * FIXES APPLIED:
         * 1. Added `pos(0,0)` to child text objects in `spawnGate`. This prevents the "add is not a function" crash
         *    caused by children lacking a transform component.
         * 2. Replaced frame-based particle spawning (time % x) with proper `loop()` timers to prevent
         *    WebGL feedback loops and improve performance.
         * 3. Added `opacity()` component to all objects using `lifespan({ fade: ... })`.
         * 4. Ensured `player.exists()` checks in all async callbacks.
         */

        // -- CONFIG: Gameplay constants & Theme Colors --
        const C = {
            scrollSpeed: 140,       // pixels/sec
            playerSpeed: 300,       // lane-switch speed
            playerHP: 3,            // lives
            gateSpacing: 600,       // pixels between gates
            laneCount: 3,           // top, mid, bot
            laneHeight: 70,         // vertical space per lane
            floorY: 340,            // ground level
            
            // -- THEME COLORS (Forest/Garden) --
            bg: [20, 40, 20],               // Deep Forest Green
            floorCol: [60, 45, 30],         // Rich Soil Brown
            laneLineCol: [100, 200, 100],   // Viny Green
            playerCol: [50, 200, 50],       // Leaf Green (Sprout)
            playerBloomCol: [255, 100, 200],// Flower Pink
            
            // Gate Colors
            correctCol: [255, 255, 100],    // Sunlight Yellow (Input)
            wrongCol: [80, 80, 80],         // Smoke/Stressor (Non-Input)
            neutralCol: [200, 220, 150],    // Pale Plant Green
            questionCol: [255, 255, 255],   // White Text
            
            // Addon Constants
            chargeGain: 34,                 // % per correct answer (3 hits to fill)
            bloomDuration: 5,               // seconds
        };

        // -- QUESTIONS: Photosynthesis Inputs/Outputs --
        const QUESTIONS = [
            {
                question: "What energy source do plants need?",
                answers: ["Sunlight", "Moonlight", "Electricity"],
                correct: 0,
            },
            {
                question: "Which gas do plants absorb from air?",
                answers: ["Oxygen", "Nitrogen", "Carbon Dioxide"],
                correct: 2,
            },
            {
                question: "What liquid do roots absorb?",
                answers: ["Soda", "Vinegar", "Water"],
                correct: 2,
            },
            {
                question: "What sugar do plants make for food?",
                answers: ["Glucose", "Salt", "Lactose"],
                correct: 0,
            },
            {
                question: "What gas do plants release?",
                answers: ["Oxygen", "Methane", "Helium"],
                correct: 0,
            },
            {
                question: "Which part of the plant catches sunlight?",
                answers: ["Roots", "Leaves", "Seeds"],
                correct: 1,
            },
            {
                question: "What green pigment traps sunlight?",
                answers: ["Chlorophyll", "Melanin", "Keratin"],
                correct: 0,
            },
            {
                question: "What is the process of making food called?",
                answers: ["Digestion", "Respiration", "Photosynthesis"],
                correct: 2,
            }
        ];

        // -- Shuffle utility --
        function shuffleAnswers() {
            QUESTIONS.forEach((q) => {
                const correctAnswer = q.answers[q.correct];
                // Fisher-Yates shuffle
                for (let i = q.answers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [q.answers[i], q.answers[j]] = [q.answers[j], q.answers[i]];
                }
                q.correct = q.answers.indexOf(correctAnswer);
            });
        }

        const canvasW = 800;
        const canvasH = 450;
        
        kaplay({ 
            width: canvasW, 
            height: canvasH, 
            background: C.bg, 
            crisp: true, 
            letterbox: true 
        });

        loadBean(); 

        // ==================
        //  GAME SCENE
        // ==================
        scene("game", () => {
            shuffleAnswers(); 

            // Game State
            let score = 0;
            let hp = C.playerHP;
            let charge = 0;          // 0 to 100
            let isBlooming = false;  // Addon state
            let nextGateX = canvasW + 200;
            let answered = new Set();
            
            // Lane Setup
            const laneYs = [];
            for (let i = 0; i < C.laneCount; i++) {
                laneYs.push(C.floorY - (C.laneCount - 1 - i) * C.laneHeight);
            }
            let currentLane = 1; // Middle lane
            let targetY = laneYs[currentLane];

            // -- BACKGROUND --
            // Ground
            add([
                rect(canvasW, canvasH - C.floorY + C.laneHeight),
                pos(0, C.floorY + C.laneHeight / 2),
                color(...C.floorCol),
                fixed(),
                z(0),
            ]);

            // Lane Lines (Vines)
            for (let i = 0; i < C.laneCount; i++) {
                add([
                    rect(canvasW, 4),
                    pos(0, laneYs[i] + C.laneHeight / 2),
                    color(...C.laneLineCol),
                    opacity(0.15),
                    fixed(),
                    z(1),
                ]);
            }

            // -- PLAYER (The Sprout) --
            const player = add([
                rect(32, 32, { radius: 16 }), // Rounded sprout shape
                pos(100, laneYs[currentLane]),
                anchor("center"),
                color(...C.playerCol),
                scale(1),
                area(),
                z(20),
                "player",
            ]);

            // Add a little leaf detail to player
            player.add([
                rect(10, 20, { radius: 5 }),
                pos(0, -20), // Local position
                anchor("bottom"),
                color(40, 180, 40),
                rotate(20),
            ]);

            // -- CONTROLS --
            function changeLane(dir) {
                currentLane += dir;
                if (currentLane < 0) currentLane = 0;
                if (currentLane >= C.laneCount) currentLane = C.laneCount - 1;
                targetY = laneYs[currentLane];
            }
            onKeyPress("up", () => changeLane(-1));
            onKeyPress("w", () => changeLane(-1));
            onKeyPress("down", () => changeLane(1));
            onKeyPress("s", () => changeLane(1));

            // Smooth Movement
            onUpdate(() => {
                if (player.exists()) {
                    player.pos.y = lerp(player.pos.y, targetY, dt() * 12);
                }
            });

            // -- AMBIENT PARTICLES (Leaves) --
            loop(0.3, () => {
                add([
                    circle(rand(2, 4)),
                    pos(canvasW + 20, rand(0, C.floorY)),
                    color(60, 100, 60),
                    opacity(rand(0.2, 0.5)),
                    move(LEFT, C.scrollSpeed * 0.5),
                    z(5),
                    "leaf",
                    lifespan(6),
                ]);
            });

            // =========================
            //  ADDON: CHLOROPLAST CHARGE
            // =========================

            // Charge Bar UI
            add([
                rect(104, 24, { radius: 4 }),
                pos(18, 58),
                color(0, 0, 0),
                fixed(),
                z(50)
            ]);
            const chargeBar = add([
                rect(0, 16, { radius: 2 }),
                pos(20, 62),
                color(0, 255, 0),
                fixed(),
                z(51),
                "chargeBar"
            ]);
            add([
                text("CHLOROPLAST CHARGE", { size: 10 }),
                pos(20, 46),
                color(150, 255, 150),
                fixed(),
                z(51)
            ]);

            // Bloom Logic
            function startBloom() {
                if (isBlooming) return;
                isBlooming = true;
                charge = 100;
                
                // Transform Player
                player.color = rgb(...C.playerBloomCol);
                tween(player.scale, vec2(1.3), 0.5, (v) => player.scale = v, easings.easeOutBack);
                
                addKaboom(player.pos);
                shake(5);

                // Bloom Text
                add([
                    text("BLOOM STATE!", { size: 32 }),
                    pos(center()),
                    anchor("center"),
                    color(255, 100, 200),
                    opacity(1),
                    lifespan(2, { fade: 0.5 }),
                    fixed(),
                    z(100)
                ]);

                // End Bloom Timer
                wait(C.bloomDuration, endBloom);
            }

            function endBloom() {
                if (!isBlooming) return; // Already ended
                isBlooming = false;
                charge = 0;
                
                // Revert Player
                if (player.exists()) {
                    player.color = rgb(...C.playerCol);
                    tween(player.scale, vec2(1), 0.5, (v) => player.scale = v, easings.easeOutBack);
                }
            }

            // Bloom Particle Loop (Oxygen Trails)
            loop(0.15, () => {
                if (isBlooming && player.exists()) {
                    add([
                        circle(6),
                        pos(player.pos.add(vec2(rand(-10, 10), rand(-10, 10)))),
                        color(200, 240, 255),
                        opacity(0.8),
                        move(LEFT, 150),
                        lifespan(0.6, { fade: 0.6 }),
                        z(19),
                    ]);
                }
            });

            // Bloom Coin Loop (Glucose)
            loop(0.4, () => {
                if (isBlooming) {
                    const yPos = laneYs[Math.floor(rand(0, 3))];
                    add([
                        circle(8),
                        pos(canvasW + 50, yPos),
                        color(255, 255, 0),
                        area({ scale: 1.5 }), // larger pickup area
                        anchor("center"),
                        z(25),
                        "glucose",
                        { val: 50 }
                    ]);
                }
            });

            // Charge Bar Update
            onUpdate(() => {
                if (chargeBar.exists()) {
                    chargeBar.width = lerp(chargeBar.width, charge, dt() * 10);
                }
            });

            // Glucose Magnet & Collection
            onUpdate("glucose", (g) => {
                g.pos.x -= C.scrollSpeed * dt(); // Natural scroll
                
                if (isBlooming && player.exists()) {
                    // Magnet effect
                    const dist = player.pos.dist(g.pos);
                    if (dist < 400) {
                        const dir = player.pos.sub(g.pos).unit();
                        g.move(dir.scale(500)); // Fly towards player
                    }
                }
                
                if (g.pos.x < -50) destroy(g);
            });

            onCollide("player", "glucose", (p, g) => {
                destroy(g);
                score += g.val;
                add([
                    text("+" + g.val, { size: 14 }),
                    pos(p.pos.x, p.pos.y - 30),
                    color(255, 255, 0),
                    opacity(1),
                    move(UP, 100),
                    lifespan(0.5, { fade: 0.5 }),
                    z(100)
                ]);
            });


            // =========================
            //  QUIZ MECHANICS
            // =========================
            function spawnGate(qIdx) {
                if (qIdx >= QUESTIONS.length) return;
                const q = QUESTIONS[qIdx];
                const gateX = nextGateX;

                // Question Banner
                add([
                    text(q.question, { size: 18, width: 400, align: "center" }),
                    pos(gateX, C.floorY - C.laneCount * C.laneHeight - 30),
                    anchor("center"),
                    color(...C.questionCol),
                    z(25),
                    "scrollable",
                    { gateIdx: qIdx },
                ]);

                // Answer Blocks
                for (let lane = 0; lane < C.laneCount; lane++) {
                    const isCorrect = lane === q.correct;
                    
                    // Container for the answer
                    const block = add([
                        rect(90, C.laneHeight - 12, { radius: 8 }),
                        pos(gateX, laneYs[lane]),
                        anchor("center"),
                        color(...C.neutralCol),
                        outline(3, rgb(60, 80, 60)),
                        area(),
                        z(15),
                        "answerblock",
                        "scrollable",
                        {
                            gateIdx: qIdx,
                            lane,
                            isCorrect,
                            revealed: false,
                        },
                    ]);

                    // Answer Text
                    // FIX: Added pos(0,0) to child to prevent runtime crash
                    block.add([
                        text(q.answers[lane], { size: 13, width: 80, align: "center" }),
                        pos(0, 0),
                        anchor("center"),
                        color(40, 60, 40),
                    ]);
                }

                nextGateX += C.gateSpacing;
            }

            // Scroll Logic
            onUpdate("scrollable", (s) => {
                s.pos.x -= C.scrollSpeed * dt();
                if (s.pos.x < -300) destroy(s);
            });

            // Collision with Gate
            onCollide("player", "answerblock", (p, block) => {
                if (block.revealed) return;
                if (answered.has(block.gateIdx)) return;
                
                answered.add(block.gateIdx);

                // Reveal logic for all blocks in this gate
                get("answerblock").forEach((b) => {
                    if (b.gateIdx === block.gateIdx) {
                        b.revealed = true;
                        b.color = b.isCorrect ? rgb(...C.correctCol) : rgb(...C.wrongCol);
                    }
                });

                if (block.isCorrect) {
                    // CORRECT
                    score += 100;
                    addKaboom(player.pos);
                    
                    // Add Charge
                    if (!isBlooming) {
                        charge += C.chargeGain;
                        if (charge >= 100) startBloom();
                    }

                    // Floating Text
                    add([
                        text("Input Acquired!", { size: 20 }),
                        pos(player.pos.x, player.pos.y - 50),
                        anchor("center"),
                        color(100, 255, 100),
                        opacity(1),
                        move(UP, 50),
                        lifespan(1.0, { fade: 0.5 }),
                        z(100),
                    ]);

                } else {
                    // WRONG
                    shake(8);
                    
                    // Penalty: Lose HP and Stress
                    hp--;
                    
                    add([
                        text("Stressor!", { size: 20 }),
                        pos(player.pos.x, player.pos.y - 50),
                        anchor("center"),
                        color(255, 80, 80),
                        opacity(1),
                        move(UP, 50),
                        lifespan(1.0, { fade: 0.5 }),
                        z(100),
                    ]);
                    
                    if (hp <= 0) {
                        wait(1, () => go("gameover", { score, answered: answered.size, total: QUESTIONS.length }));
                    }
                }

                // Win check
                if (answered.size >= QUESTIONS.length) {
                    // Wait a bit before winning to finish animations
                    wait(2.0, () => {
                        go("win", { score, hp, total: QUESTIONS.length });
                    });
                }
            });

            // Spawn all gates
            for (let i = 0; i < QUESTIONS.length; i++) {
                spawnGate(i);
            }

            // -- HUD START --
            const scoreText = add([
                text(`Score: 0`, { size: 20 }),
                pos(20, 20), color(255, 255, 255), fixed(), z(50),
            ]);
            
            // Lives (Hearts)
            const hearts = [];
            for (let i = 0; i < C.playerHP; i++) {
                hearts.push(add([
                    text("â™¥", { size: 22 }),
                    pos(200 + i * 24, 22),
                    color(255, 100, 100),
                    opacity(1), 
                    fixed(),
                    z(50)
                ]));
            }
            
            // Update HUD
            onUpdate(() => {
                scoreText.text = `Score: ${score}`;
                
                // Toggle heart visibility based on HP
                for (let i = 0; i < hearts.length; i++) {
                    hearts[i].opacity = (i < hp) ? 1 : 0.2;
                }
            });
            // -- HUD END --
            
            add([
                text("UP/DOWN to Switch Lanes", { size: 12 }),
                pos(canvasW/2, canvasH - 20),
                anchor("center"),
                color(150, 180, 150),
                fixed(),
                z(50)
            ]);

            // Ground Markers for Speed sensation
            loop(0.4, () => {
                add([
                    rect(30, 4),
                    pos(canvasW + 10, C.floorY + C.laneHeight/2 + rand(0, 30)),
                    color(50, 40, 30),
                    opacity(0.3),
                    move(LEFT, C.scrollSpeed),
                    lifespan(3),
                    z(2)
                ]);
            });
        });

        // ==================
        //  GAME OVER SCENE
        // ==================
        scene("gameover", ({ score, answered, total }) => {
            add([
                rect(canvasW, canvasH),
                color(20, 20, 20),
            ]);
            add([
                text("PLANT WITHERED", { size: 48 }), 
                pos(center()), 
                anchor("center"), 
                color(220, 60, 60)
            ]);
            add([
                text(`Score: ${score}  |  Questions: ${answered}/${total}`, { size: 20 }), 
                pos(center().x, center().y + 60), 
                anchor("center"), 
                color(255, 255, 255)
            ]);
            add([
                text("Press SPACE to sprout again", { size: 16 }), 
                pos(center().x, center().y + 120), 
                anchor("center"), 
                color(150, 150, 150)
            ]);
            
            onKeyPress("space", () => go("game"));
            onClick(() => go("game"));
        });

        // ==================
        //  WIN SCENE
        // ==================
        scene("win", ({ score, hp, total }) => {
            add([
                rect(canvasW, canvasH),
                color(20, 40, 20),
            ]);
            // Confetti
            loop(0.1, () => {
                add([
                    rect(6, 6),
                    pos(rand(0, canvasW), 0),
                    color(rand(100, 255), rand(100, 255), 100),
                    move(DOWN, rand(100, 200)),
                    opacity(1),
                    lifespan(2, { fade: 0.5 }),
                ]);
            });

            add([
                text("FULL BLOOM!", { size: 48 }), 
                pos(center()), 
                anchor("center"), 
                color(100, 255, 100)
            ]);
            add([
                text(`Final Score: ${score}`, { size: 24 }), 
                pos(center().x, center().y + 60), 
                anchor("center"), 
                color(255, 255, 100)
            ]);
            add([
                text("You mastered Photosynthesis!", { size: 16 }), 
                pos(center().x, center().y + 100), 
                anchor("center"), 
                color(200, 220, 200)
            ]);
            add([
                text("Press SPACE to play again", { size: 14 }), 
                pos(center().x, center().y + 140), 
                anchor("center"), 
                color(150, 180, 150)
            ]);

            onKeyPress("space", () => go("game"));
            onClick(() => go("game"));
        });

        // -- START --
        go("game");

    </script>
</body>
</html>